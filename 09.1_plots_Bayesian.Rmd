---
title: "09.1_plots_Bayesian"
author: "Chiara Draxler & Laura Botzet"
date: "24 1 2022"
output: html_document
---

##1. Load Data
```{r}
# load("cccu_MA.RData")
# load("cccu_SA.RData")
# length(unique(cccu_SA$CASEID)) #women
# load("cccu_R1.RData")
# load("cccu_R2.RData")
# load("cccu_R3.RData")
# load("cccu_R1_s.RData")
# length(unique(cccu_R1_s$CASEID)) #women
# load("cccu_R2_s.RData")
# load("cccu_R3_s.RData")
```


##2. Load Packages
```{r}
# library(formr)
# library(effects)
# library(EValue)
# library(lme4)
# library(psych)
# library(dplyr)
# library(tidyverse)
# library(patchwork)
# library(marginaleffects)
# library(ggpubr)
# library(sjPlot)
library(brms)
library(marginaleffects)
library(sjPlot)
library(tidyverse)



options(scipen=999)

apatheme = theme_bw() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    axis.line = element_line(),
    text = element_text(family = 'Times')
  ) +
  theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 12)
  )
```


## 3. Specific effects
Plots for
- hc*contra_satis
- hc*sexual_satisfaction
- hc*sex_freq
- hc_dur*contra_satis
based on multilevel model m3
```{r}
m3 <- brm(file = "models/m3.Rds")

### contra_satis

contra_satis <- plot_model(m3, type = "pred",
                           terms = c("contra_satis", "hc"),
                           ci.lvl = 0.997) +
  scale_fill_manual(
    values = c("red", "blue"),
    name = "Group",
    breaks = c("hc", "non_hc"),
    labels = c(
      "HC",
      "Non-HC"
    ),
  ) +
  scale_colour_manual(
    values = c("red", "blue"),
    name  = "Group",
    breaks = c("hc", "non_hc"),
    labels = c(
      "HC",
      "Non-HC"
    )
  ) +
  labs(y = "Probability to Switch", title = "") +
  scale_x_discrete("Contraceptive Satisfaction",
                   limits = c("1", "2", "3", "4")) +
  apatheme

contra_satis

ggsave("contra_satis.pdf", contra_satis)

ggsave("contra_satis.png", contra_satis)
###sexual satisfaction

sex_sat <- plot_model(m3, type = "pred", terms = c("sexual_satisfaction", "hc"), ci.lvl = 0.997)  +  labs(color = "Group",  fill = "Group") +
  scale_fill_manual(
    values = c("red", "blue"),
    name = "Group",
    breaks = c("hc", "non_hc"),
     labels = c(
      "HC",
      "Non-HC"
    ),
  ) +
  scale_colour_manual(
    values = c("red", "blue"),
    name  = "Group",
    breaks = c("hc", "non_hc"),
    labels = c(
      "HC",
      "Non-HC"
    )
  ) +
  labs(y = "Probability to Switch", title = "") +
  scale_x_discrete("Sexual Satisfaction",
                   limits = c("1", "2", "3", "4", "5", "6")) +
  apatheme
sex_sat

ggsave("sexual_satis.pdf", sex_sat)

ggsave("sexual_satis.png", sex_sat)

###sexual frequency

sex_freq <- plot_model(m3, type = "pred", terms = c("sex_freq", "hc"), ci.lvl = 0.997)  +
  labs(color = "Group",  fill = "Group") +
  scale_fill_manual(
    values = c("red", "blue"),
    name = "Group",
    breaks = c("hc", "non_hc"),
    labels = c(
      "HC",
      "Non-HC"
    ),
  ) +
  scale_colour_manual(
    values = c("red", "blue"),
    name  = "Group",
    breaks = c("hc", "non_hc"),
    labels = c(
      "HC",
      "Non-HC"
    )
  ) +
  labs(y = "Probability to Switch", title = "") +
  scale_x_discrete("Sexual Frequency",
                   limits = c("No sex or once", "2-5 times","6-10 times", "11 or more times"), guide = guide_axis(n.dodge=2)) +
  apatheme
sex_freq

ggsave("sexual_freq.pdf", sex_freq)

ggsave("sexual_freq.png", sex_freq)

#for hc dur

sa_m3 <- glmer(switch ~ contra_satis* hc_dur  +  sexual_satisfaction +  sex_freq + (1| CASEID), family = binomial, data = cccu_SA, control=glmerControl(optimizer="bobyqa"))
summary(sa_m3)


hc_dur<-
  plot_model(sa_m3, type = "pred",  show.legend = TRUE,
             terms = c("contra_satis","hc_dur[0, 12,24,36,48]"), ci.lvl = 0.997) +
  labs(y = "Probability to Switch", title = "") +
  scale_x_discrete("Contraceptive Satisfaction",
                   limits = c("1", "2", "3", "4"))+
  scale_color_discrete(name = "Duration", labels = c("< 1 year",
                                                     "1-2 years",
                                                     "2-3 years",
                                                     "3-4 years",
                                                     ">4 years")) +
  apatheme

hc_dur





ggsave("hc_dur.pdf", hc_dur)

ggsave("hc_dur.png", hc_dur)


```



## 4. Forest plot main effects
for models m1, m2, m3, m3_lm, and m4_lm

### Models
####m1
```{r}
m1 <- glmer(switch ~ hc + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))

m1_sum = summary(m1)
```

####m1 in robustness analyses
```{r}
####1 Robustness analyses : m1 
R1_ma_1 <- glmer(switch ~ hc + (1| CASEID), family = binomial, data = cccu_R1, control=glmerControl(optimizer="bobyqa"))

R1_m1_sum = summary(R1_ma_1)

####2 Robustness analyses: m1 
R2_ma_1 <- glmer(switch ~ hc + (1| CASEID), family = binomial, data = cccu_R2, control=glmerControl(optimizer="bobyqa"))

R2_m1_sum = summary(R2_ma_1)

#### 3Robustness analyses: m1 
R3_ma_1 <- glmer(switch ~ hc + (1| CASEID), family = binomial, data = cccu_R3, control=glmerControl(optimizer="bobyqa"))

R3_m1_sum = summary(R3_ma_1)

```


####m2
```{r}
m2 <- glmer(switch ~ hc*contra_satis + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))

m2_sum = summary(m2)
```

####m2 in robustness analyses 
```{r}
#r1
R1_ma_2 <- glmer(switch ~ hc*contra_satis + (1| CASEID), family = binomial, data = cccu_R1, control=glmerControl(optimizer="bobyqa"))

R1_m2_sum = summary(R1_ma_2)

#r2
R2_ma_2 <- glmer(switch ~ hc*contra_satis + (1| CASEID), family = binomial, data = cccu_R2, control=glmerControl(optimizer="bobyqa"))

R2_m2_sum = summary(R2_ma_2)


#r3
R3_ma_2 <- glmer(switch ~ hc*contra_satis + (1| CASEID), family = binomial, data = cccu_R3, control=glmerControl(optimizer="bobyqa"))

R3_m2_sum = summary(R3_ma_2)
```

####m3
```{r}
m3 <- glmer(switch ~ hc * contra_satis +  hc * sexual_satisfaction + hc * sex_freq + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))
m3_sum = summary(m3)
```

####m3 in robustness analyses 
```{r}
#r1
R1_ma_3 <- glmer(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + (1| CASEID), family = binomial, data = cccu_R1, control=glmerControl(optimizer="bobyqa"))

R1_m3_sum = summary(R1_ma_3)

#r2
R2_ma_3 <- glmer(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + (1| CASEID), family = binomial, data = cccu_R2, control=glmerControl(optimizer="bobyqa"))

R2_m3_sum = summary(R2_ma_3)

#r3
R3_ma_3 <- glmer(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + (1| CASEID), family = binomial, data = cccu_R3, control=glmerControl(optimizer="bobyqa"))

R3_m3_sum = summary(R3_ma_3)
```



####m3_lm
```{r}
#filter for first measurement occasion
length(unique(cccu_MA$CASEID))


cccu_MA_sens = cccu_MA %>%
  group_by(CASEID) %>%
  arrange(WAVE) %>%
  mutate(count = row_number()) %>%
  ungroup()

cccu_MA_sens = cccu_MA_sens %>%
  filter(count == 1)

table(cccu_MA_sens$WAVE)

#repeat model 3 for sensitivity analyses
m3_lm = glm(switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq,
          family = binomial,
          data = cccu_MA_sens)

m3_lm_sum <- summary(m3_lm)
```

####m3lm in robustness analyses
```{r}

#r1

#filter for first measurement occasion
length(unique(cccu_R1$CASEID))


cccu_R1_sens = cccu_R1 %>%
  group_by(CASEID) %>%
  arrange(WAVE) %>%
  mutate(count = row_number()) %>%
  ungroup()

cccu_R1_sens = cccu_R1_sens %>%
  filter(count == 1)

table(cccu_R1_sens$WAVE)

#repeat model 3 for sensitivity analyses
R1_m3_lm = glm(switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq,
          family = binomial,
          data = cccu_R1_sens)
R1_m3lm_sum = summary(R1_m3_lm)



#R2

#filter for first measurement occasion
length(unique(cccu_R2$CASEID))


cccu_R2_sens = cccu_R2 %>%
  group_by(CASEID) %>%
  arrange(WAVE) %>%
  mutate(count = row_number()) %>%
  ungroup()

cccu_R2_sens = cccu_R2_sens %>%
  filter(count == 1)

table(cccu_R2_sens$WAVE)

#repeat model 3 for sensitivity analyses
R2_m3_lm = glm(switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq,
          family = binomial,
          data = cccu_R2_sens)
R2_m3lm_sum = summary(R2_m3_lm)

#R3

#filter for first measurement occasion
length(unique(cccu_R3$CASEID))


cccu_R3_sens = cccu_R3 %>%
  group_by(CASEID) %>%
  arrange(WAVE) %>%
  mutate(count = row_number()) %>%
  ungroup()

cccu_R3_sens = cccu_R3_sens %>%
  filter(count == 1)

table(cccu_R3_sens$WAVE)

#repeat model 3 for sensitivity analyses
R3_m3_lm = glm(switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq,
          family = binomial,
          data = cccu_R3_sens)
R3_m3lm_sum = summary(R3_m3_lm)


```



####m4_lm
```{r}
m4_lm = glm(switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq + hc *AGE + hc *DEGREE_recode +
              hc *POVRATE +
              hc *HLTHPROB_recode + hc *MEDPROB_recode +  hc *GAPINS_recode +
              hc *TYPEINS_recode + hc *NKIDS_t1 +  hc *pregnant_between_waves + hc *had_baby_between_waves+ hc *Avoid_r +
              hc *FEELPG_recode +
              hc *rel_dur_factor,
            family = binomial,
            data = cccu_MA_sens)
m4_lm_sum <- summary(m4_lm)
```

####m4lm in robustness analysis 
```{r}
#r1
R1_m4_lm <- glm(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + hc *AGE + hc *DEGREE_recode + hc *POVRATE + hc *HLTHPROB_recode + hc *MEDPROB_recode +  hc *GAPINS_recode + hc *TYPEINS_recode + hc *NKIDS_t1 +  hc *pregnant_between_waves + hc *had_baby_between_waves+ hc *Avoid_r + hc *FEELPG_recode + hc *rel_dur_factor, family = binomial, data = cccu_R1_sens)

R1_m4lm_sum = summary(R1_m4_lm)

#r2
R2_m4_lm <- glm(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + hc *AGE + hc *DEGREE_recode + hc *POVRATE + hc *HLTHPROB_recode + hc *MEDPROB_recode +  hc *GAPINS_recode + hc *TYPEINS_recode + hc *NKIDS_t1 +  hc *pregnant_between_waves + hc *had_baby_between_waves+ hc *Avoid_r + hc *FEELPG_recode + hc *rel_dur_factor, family = binomial, data = cccu_R2_sens)

R2_m4lm_sum = summary(R2_m4_lm)

#r3
R3_m4_lm <- glm(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + hc *AGE + hc *DEGREE_recode + hc *POVRATE + hc *HLTHPROB_recode + hc *MEDPROB_recode +  hc *GAPINS_recode + hc *TYPEINS_recode + hc *NKIDS_t1 +  hc *pregnant_between_waves + hc *had_baby_between_waves+ hc *Avoid_r + hc *FEELPG_recode + hc *rel_dur_factor, family = binomial, data = cccu_R3_sens)

R3_m4lm_sum = summary(R3_m4_lm)
```


### Effects and CIs
####m1
```{r}
m1_confint = confint(m1, method = "Wald", level = .997) 

rn = rownames(m1_confint)
m1_confint = data.frame(m1_confint)

colnames(m1_confint) = c("lower", "upper")
m1_confint$predictor = rn


m1_forest_plot = data.frame(
  predictor = names(m1_sum$coefficients[,1]),
  estimate = as.numeric(as.character(m1_sum$coefficients[,1])))

m1_forest_plot = left_join(m1_forest_plot, m1_confint, by = "predictor")

m1_forest_plot$group = rep("multilevel_model_1", 2)

```

####m1 in Robustnessanalyses
```{r}
#R1
R1_m1_confint = confint(R1_ma_1, method = "Wald", level = .997) 

rn = rownames(R1_m1_confint)
R1_m1_confint = data.frame(R1_m1_confint)

colnames(R1_m1_confint) = c("lower", "upper")
R1_m1_confint$predictor = rn


R1_m1_forest_plot = data.frame(
  predictor = names(R1_m1_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R1_m1_sum$coefficients[,1])))

R1_m1_forest_plot = left_join(R1_m1_forest_plot, R1_m1_confint, by = "predictor")

R1_m1_forest_plot$group = rep("R1_multilevel_model_1", 2)


#R2
R2_m1_confint = confint(R2_ma_1, method = "Wald", level = .997) 

rn = rownames(R2_m1_confint)
R2_m1_confint = data.frame(R2_m1_confint)

colnames(R2_m1_confint) = c("lower", "upper")
R2_m1_confint$predictor = rn


R2_m1_forest_plot = data.frame(
  predictor = names(R2_m1_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R2_m1_sum$coefficients[,1])))

R2_m1_forest_plot = left_join(R2_m1_forest_plot, R2_m1_confint, by = "predictor")

R2_m1_forest_plot$group = rep("R2_multilevel_model_1", 2)


#R3
R3_m1_confint = confint(R3_ma_1, method = "Wald", level = .997) 

rn = rownames(R3_m1_confint)
R3_m1_confint = data.frame(R3_m1_confint)

colnames(R3_m1_confint) = c("lower", "upper")
R3_m1_confint$predictor = rn


R3_m1_forest_plot = data.frame(
  predictor = names(R3_m1_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R3_m1_sum$coefficients[,1])))

R3_m1_forest_plot = left_join(R3_m1_forest_plot, R3_m1_confint, by = "predictor")

R3_m1_forest_plot$group = rep("R3_multilevel_model_1", 2)


```


####m2
```{r}
m2_confint = confint(m2, method = "Wald", level = .997) 

rn = rownames(m2_confint)
m2_confint = data.frame(m2_confint)

colnames(m2_confint) = c("lower", "upper")
m2_confint$predictor = rn


m2_forest_plot = data.frame(
  predictor = names(m2_sum$coefficients[,1]),
  estimate = as.numeric(as.character(m2_sum$coefficients[,1])))

m2_forest_plot = left_join(m2_forest_plot, m2_confint, by = "predictor")

m2_forest_plot$group = rep("multilevel_model_2", 4)


```


####m2 in robustness analyses
```{r}
#R1
R1_m2_confint = confint(R1_ma_2, method = "Wald", level = .997) 

rn = rownames(R1_m2_confint)
R1_m2_confint = data.frame(R1_m2_confint)

colnames(R1_m2_confint) = c("lower", "upper")
R1_m2_confint$predictor = rn


R1_m2_forest_plot = data.frame(
  predictor = names(R1_m2_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R1_m2_sum$coefficients[,1])))

R1_m2_forest_plot = left_join(R1_m2_forest_plot, R1_m2_confint, by = "predictor")

R1_m2_forest_plot$group = rep("R1_multilevel_model_2", 4)


#R2
R2_m2_confint = confint(R2_ma_2, method = "Wald", level = .997) 

rn = rownames(R2_m2_confint)
R2_m2_confint = data.frame(R2_m2_confint)

colnames(R2_m2_confint) = c("lower", "upper")
R2_m2_confint$predictor = rn


R2_m2_forest_plot = data.frame(
  predictor = names(R2_m2_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R2_m2_sum$coefficients[,1])))

R2_m2_forest_plot = left_join(R2_m2_forest_plot, R2_m2_confint, by = "predictor")

R2_m2_forest_plot$group = rep("R2_multilevel_model_2", 4)


#R3
R3_m2_confint = confint(R3_ma_2, method = "Wald", level = .997) 

rn = rownames(R3_m2_confint)
R3_m2_confint = data.frame(R3_m2_confint)

colnames(R3_m2_confint) = c("lower", "upper")
R3_m2_confint$predictor = rn


R3_m2_forest_plot = data.frame(
  predictor = names(R3_m2_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R3_m2_sum$coefficients[,1])))

R3_m2_forest_plot = left_join(R3_m2_forest_plot, R3_m2_confint, by = "predictor")

R3_m2_forest_plot$group = rep("R3_multilevel_model_2", 4)



```




####m3
```{r}
m3_confint = confint(m3, method = "Wald", level = .997) 

rn = rownames(m3_confint)
m3_confint = data.frame(m3_confint)

colnames(m3_confint) = c("lower", "upper")
m3_confint$predictor = rn


m3_forest_plot = data.frame(
  predictor = names(m3_sum$coefficients[,1]),
  estimate = as.numeric(as.character(m3_sum$coefficients[,1])))

m3_forest_plot = left_join(m3_forest_plot, m3_confint, by = "predictor")

m3_forest_plot$group = rep("multilevel_model_3", 12)

```

####m3 in robustness analyses 

```{r}
#R1
R1_m3_confint = confint(R1_ma_3, method = "Wald", level = .997) 

rn = rownames(R1_m3_confint)
R1_m3_confint = data.frame(R1_m3_confint)

colnames(R1_m3_confint) = c("lower", "upper")
R1_m3_confint$predictor = rn


R1_m3_forest_plot = data.frame(
  predictor = names(R1_m3_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R1_m3_sum$coefficients[,1])))

R1_m3_forest_plot = left_join(R1_m3_forest_plot, R1_m3_confint, by = "predictor")

R1_m3_forest_plot$group = rep("R1_multilevel_model_3", 4)


#R2
R2_m3_confint = confint(R2_ma_3, method = "Wald", level = .997) 

rn = rownames(R2_m3_confint)
R2_m3_confint = data.frame(R2_m3_confint)

colnames(R2_m3_confint) = c("lower", "upper")
R2_m3_confint$predictor = rn


R2_m3_forest_plot = data.frame(
  predictor = names(R2_m3_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R2_m3_sum$coefficients[,1])))

R2_m3_forest_plot = left_join(R2_m3_forest_plot, R2_m3_confint, by = "predictor")

R2_m3_forest_plot$group = rep("R2_multilevel_model_3", 4)


#R3
R3_m3_confint = confint(R3_ma_3, method = "Wald", level = .997) 

rn = rownames(R3_m3_confint)
R3_m3_confint = data.frame(R3_m3_confint)

colnames(R3_m3_confint) = c("lower", "upper")
R3_m3_confint$predictor = rn


R3_m3_forest_plot = data.frame(
  predictor = names(R3_m3_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R3_m3_sum$coefficients[,1])))

R3_m3_forest_plot = left_join(R3_m3_forest_plot, R3_m3_confint, by = "predictor")

R3_m3_forest_plot$group = rep("R3_multilevel_model_3", 4)




```

####m3_lm
```{r}
m3_lm_confint = confint(m3_lm, method = "Wald", level = .997) 

rn = rownames(m3_lm_confint)
m3_lm_confint = data.frame(m3_lm_confint)

colnames(m3_lm_confint) = c("lower", "upper")
m3_lm_confint$predictor = rn


m3_lm_forest_plot = data.frame(
  predictor = names(m3_lm$coefficients),
  estimate = as.numeric(as.character(m3_lm$coefficients)))

m3_lm_forest_plot = left_join(m3_lm_forest_plot, m3_lm_confint, by = "predictor")

m3_lm_forest_plot$group = rep("model_3", 12)
```
####m3_lm in robustnessanalyses 
```{r}
#R1
R1_m3lm_confint = confint(R1_m3_lm, method = "Wald", level = .997) 

rn = rownames(R1_m3lm_confint)
R1_m3lm_confint = data.frame(R1_m3lm_confint)

colnames(R1_m3lm_confint) = c("lower", "upper")
R1_m3lm_confint$predictor = rn


R1_m3lm_forest_plot = data.frame(
  predictor = names(R1_m3lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R1_m3lm_sum$coefficients[,1])))

R1_m3lm_forest_plot = left_join(R1_m3lm_forest_plot, R1_m3lm_confint, by = "predictor")

R1_m3lm_forest_plot$group = rep("R1_linear_model_3", 4)


#R2
R2_m3lm_confint = confint(R2_m3_lm, method = "Wald", level = .997) 

rn = rownames(R2_m3lm_confint)
R2_m3lm_confint = data.frame(R2_m3lm_confint)

colnames(R2_m3lm_confint) = c("lower", "upper")
R2_m3lm_confint$predictor = rn


R2_m3lm_forest_plot = data.frame(
  predictor = names(R2_m3lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R2_m3lm_sum$coefficients[,1])))

R2_m3lm_forest_plot = left_join(R2_m3lm_forest_plot, R2_m3lm_confint, by = "predictor")

R2_m3lm_forest_plot$group = rep("R2_linear_model_3", 4)


#R3
R3_m3lm_confint = confint(R3_m3_lm, method = "Wald", level = .997) 

rn = rownames(R3_m3lm_confint)
R3_m3lm_confint = data.frame(R3_m3lm_confint)

colnames(R3_m3lm_confint) = c("lower", "upper")
R3_m3lm_confint$predictor = rn


R3_m3lm_forest_plot = data.frame(
  predictor = names(R3_m3lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R3_m3lm_sum$coefficients[,1])))

R3_m3lm_forest_plot = left_join(R3_m3lm_forest_plot, R3_m3lm_confint, by = "predictor")

R3_m3lm_forest_plot$group = rep("R3_linear_model_3", 4)



```





####m4
```{r}
m4_lm_confint = confint(m4_lm, parm = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                               "hcnon_hc:contra_satis",
                                               "hcnon_hc:sexual_satisfaction",
                                               "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"),
                        method = "Wald", level = .997) 

rn = rownames(m4_lm_confint)
m4_lm_confint = data.frame(m4_lm_confint)

colnames(m4_lm_confint) = c("lower", "upper")
m4_lm_confint$predictor = rn


m4_lm_forest_plot = data.frame(predictor = names(m4_lm$coefficients),
  estimate = as.numeric(as.character(m4_lm$coefficients)))

m4_lm_forest_plot = left_join(m4_lm_forest_plot, m4_lm_confint, by = "predictor")

m4_lm_forest_plot$group = rep("model_4", 12)
```

####m4lm in robustnessanalyses
```{r}
#R1
R1_m4lm_confint = confint(R1_m4_lm, parm = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                               "hcnon_hc:contra_satis",
                                               "hcnon_hc:sexual_satisfaction",
                                               "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"),method = "Wald", level = .997) 

rn = rownames(R1_m4lm_confint)
R1_m4lm_confint = data.frame(R1_m4lm_confint)

colnames(R1_m4lm_confint) = c("lower", "upper")
R1_m4lm_confint$predictor = rn


R1_m4lm_forest_plot = data.frame(
  predictor = names(R1_m4lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R1_m4lm_sum$coefficients[,1])))

R1_m4lm_forest_plot = left_join(R1_m4lm_forest_plot, R1_m4lm_confint, by = "predictor")

R1_m4lm_forest_plot$group = rep("R1_linear_model_4", 71)



#R2
R2_m4lm_confint = confint(R2_m4_lm, parm = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                               "hcnon_hc:contra_satis",
                                               "hcnon_hc:sexual_satisfaction",
                                               "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"),method = "Wald", level = .997) 

rn = rownames(R2_m4lm_confint)
R2_m4lm_confint = data.frame(R2_m4lm_confint)

colnames(R2_m4lm_confint) = c("lower", "upper")
R2_m4lm_confint$predictor = rn


R2_m4lm_forest_plot = data.frame(
  predictor = names(R2_m4lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R2_m4lm_sum$coefficients[,1])))

R2_m4lm_forest_plot = left_join(R2_m4lm_forest_plot, R2_m4lm_confint, by = "predictor")

R2_m4lm_forest_plot$group = rep("R2_linear_model_4", 71)


#R3
R3_m4lm_confint = confint(R3_m4_lm, parm = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                               "hcnon_hc:contra_satis",
                                               "hcnon_hc:sexual_satisfaction",
                                               "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"),method = "Wald", level = .997) 

rn = rownames(R3_m4lm_confint)
R3_m4lm_confint = data.frame(R3_m4lm_confint)

colnames(R3_m4lm_confint) = c("lower", "upper")
R3_m4lm_confint$predictor = rn


R3_m4lm_forest_plot = data.frame(
  predictor = names(R3_m4lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R3_m4lm_sum$coefficients[,1])))

R3_m4lm_forest_plot = left_join(R3_m4lm_forest_plot, R3_m4lm_confint, by = "predictor")

R3_m4lm_forest_plot$group = rep("R3_linear_model_4", 71)

```


### Dataframe for plot
```{r}
#for robustness analyses
forest_plot_data2 = rbind(
  m1_forest_plot,
  R1_m1_forest_plot,
  R2_m1_forest_plot,
  R3_m1_forest_plot,
  R1_m2_forest_plot,
  R2_m2_forest_plot,
  R3_m2_forest_plot,
  m2_forest_plot,
  m3_forest_plot,
  R1_m3_forest_plot,
  R2_m3_forest_plot,
  R3_m3_forest_plot,
  m3_lm_forest_plot,
  R1_m3lm_forest_plot,
  R2_m3lm_forest_plot,
  R3_m3lm_forest_plot,
  m4_lm_forest_plot,
  R1_m4lm_forest_plot,
  R2_m4lm_forest_plot,
  R3_m4lm_forest_plot
)
forest_plot_data2$predictor = factor(forest_plot_data2$predictor,
                                    levels = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "hcnon_hc:contra_satis",
                                               "sexual_satisfaction","hcnon_hc:sexual_satisfaction",
                                  
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                                            "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"),
                                    labels = c("(Intercept)",
                                               "HC",
                                               "Contraceptive Satisfaction",
                                               "HC:Contraceptive Satisfaction",
                                               "Sexual Satisfaction","HC:Sexual Satisfaction",    
                                               "Sexual Frequency 2-5 times", "Sexual Frequency 6-10 times",
                                               "Sexual Frequency 11 or more times",
                                                                                          "HC:Sexual Frequency 2-5 times",
                                               "HC:Sexual Frequency 6-10 times",
                                               "HC:Sexual Frequency 11 or more times"))

forest_plot_data2$group = factor(
  forest_plot_data2$group,
  levels = 
    c(
    "multilevel_model_1",
    "R1_multilevel_model_1",
    "R2_multilevel_model_1",
    "R3_multilevel_model_1",
    "multilevel_model_2",
    "R1_multilevel_model_2",
    "R2_multilevel_model_2",
    "R3_multilevel_model_2",
    "multilevel_model_3",
    "R1_multilevel_model_3",
    "R2_multilevel_model_3",
    "R3_multilevel_model_3",
    "model_3",
    "R1_linear_model_3",
    "R2_linear_model_3",
    "R3_linear_model_3",
    "model_4",
    "R1_linear_model_4",
    "R2_linear_model_4",
    "R3_linear_model_4"
  ),
  labels = 
    c(
    "multilevel_model_1",
    "R1_multilevel_model_1",
    "R2_multilevel_model_1",
    "R3_multilevel_model_1",
    "multilevel_model_2",
    "R1_multilevel_model_2",
    "R2_multilevel_model_2",
    "R3_multilevel_model_2",
    "multilevel_model_3",
    "R1_multilevel_model_3",
    "R2_multilevel_model_3",
    "R3_multilevel_model_3",
    "model_3",
    "R1_linear_model_3",
    "R2_linear_model_3",
    "R3_linear_model_3",
    "model_4",
    "R1_linear_model_4",
    "R2_linear_model_4",
    "R3_linear_model_4"
  )
)


#give group for color:
forest_plot_data2 <- forest_plot_data2 %>%
  mutate(grouping = ifelse(group == "multilevel_model_1" |group == "R1_multilevel_model_1" | group == "R2_multilevel_model_1" | group == "R3_multilevel_model_1", "color_1",
  ifelse(group == "multilevel_model_2" |group == "R1_multilevel_model_2" | group == "R2_multilevel_model_2" | group == "R3_multilevel_model_2", "color_2",
         ifelse(group == "multilevel_model_3" |group == "R1_multilevel_model_3" | group == "R2_multilevel_model_3" | group == "R3_multilevel_model_3" ,"color_3",
                
                ifelse(group == "model_3" |group == "R1_linear_model_3" | group == "R2_linear_model_3" | group == "R3_linear_model_3", "color_4", ifelse(group == "model_4" |group == "R1_linear_model_4" | group == "R2_linear_model_4" | group == "R3_linear_model_4", "color_5",NA)))))) 


#give group for shape:
forest_plot_data2 <- forest_plot_data2 %>%
  mutate(shape = ifelse(group ==  "multilevel_model_1"|
  group == "multilevel_model_2" |
    group == "multilevel_model_3"|
    group == "model_3" |
    group == "model_4", "shape_1",
  ifelse(group %contains% "R1", "shape_2",
         ifelse(group %contains% "R2", "shape_3",
                ifelse(group %contains% "R3", "shape_4", NA)))))

```

### Plot
```{r}

#forest plot including robustness analyses

#set colors
group.color <- c("yellow", "purple", "green", "blue", "red")

forest_ma_ra <- ggplot(
  data = forest_plot_data2 %>%
    filter(predictor != "(Intercept)"),
  aes(
    x = predictor,
    y = estimate,
    group = forcats::fct_rev(grouping),
    fill = forcats::fct_rev(grouping),
    color = forcats::fct_rev(grouping),
    shape = shape
  )
) +
  geom_point(position = position_dodge(width = 0.9),
             aes(shape = shape),
             alpha = 0.08) +
  geom_pointrange(aes(ymin = lower, ymax = upper),
                  alpha = 0.5,
                  position = position_dodge(width = 0.9)) +
  scale_x_discrete(limits = rev, expand = c(0.002, 0)) +scale_y_continuous(limits = c(-8,8),
                     breaks = seq(-8,8,2)) +
  geom_hline(yintercept = 0) +
  coord_flip() +
  scale_fill_manual(
    name = "Model",
    breaks = c("color_1", "color_2", "color_3", "color_4", "color_5"),
    labels = 
      c(
      "Multilevel Model 1",
      "Multilevel Model 2",
      "Multilevel Model 3",
      "Simple Regression Model 3",
      "Simple Regression Model 4"
    ),
    values = group.color
  ) +
  scale_colour_manual(
    name = "Model",
    breaks = c("color_1", "color_2", "color_3", "color_4", "color_5"),
    labels = 
      c(
      "Multilevel Model 1",
      "Multilevel Model 2",
      "Multilevel Model 3",
      "Simple Regression Model 3",
      "Simple Regression Model 4"
    ),
    values = group.color
  ) +
  scale_shape_manual(
    name = "Analyses",
    values = c(21,22,24,25),
    labels = c(
      "Main Analyses",
      "Robustness Analyses 1",
      "Robustness Analyses 2",
      "Robustness Analyses 3"
    )
  ) +
  labs(y = "Effect Size", x = "Predictor") +
  apatheme

forest_ma_ra

ggsave("forest_ma.pdf", forest_ma_ra, width = 23, height = 12, units = "cm", dpi = 300)
ggsave("forest_ma.png", forest_ma_ra, width = 23, height = 12, units = "cm", dpi = 300)

```

#5. Forest Plot Sub Analyses

### Model
####m2
```{r}
sa_m2 <- glmer(switch ~ contra_satis * hc_dur + (1| CASEID), family = binomial, data = cccu_SA, control=glmerControl(optimizer="bobyqa"))

sa_m2_sum<- summary(sa_m2)
```

####m2 in robustness analyses 
```{r}
R1_sa_m2 <- glmer(switch ~ contra_satis * hc_dur + (1| CASEID), family = binomial, data = cccu_R1_s, control=glmerControl(optimizer="bobyqa"))

R1_sa_m2_sum <- summary(R1_sa_m2)


R2_sa_m2 <- glmer(switch ~ contra_satis * hc_dur + (1| CASEID), family = binomial, data = cccu_R2_s, control=glmerControl(optimizer="bobyqa"))

R2_sa_m2_sum <- summary(R2_sa_m2)


R3_sa_m2 <- glmer(switch ~ contra_satis * hc_dur + (1| CASEID), family = binomial, data = cccu_R3_s, control=glmerControl(optimizer="bobyqa"))

R3_sa_m2_sum <- summary(R3_sa_m2)
```



####m3
```{r}
sa_m3 <- glmer(switch ~ contra_satis* hc_dur  +  sexual_satisfaction +  sex_freq + (1| CASEID), family = binomial, data = cccu_SA, control=glmerControl(optimizer="bobyqa"))

sa_m3_sum <- summary(sa_m3)
```


####m3 in robustness analyses 
```{r}
R1_sa_m3 <- glmer(switch ~ contra_satis * hc_dur +  sexual_satisfaction +  sex_freq + (1| CASEID), family = binomial, data = cccu_R1_s, control=glmerControl(optimizer="bobyqa"))

R1_sa_m3_sum <- summary(R1_sa_m3)


R2_sa_m3 <- glmer(switch ~ contra_satis * hc_dur +  sexual_satisfaction +  sex_freq + (1| CASEID), family = binomial, data = cccu_R2_s, control=glmerControl(optimizer="bobyqa"))

R2_sa_m3_sum <- summary(R2_sa_m3)


R3_sa_m3 <- glmer(switch ~ contra_satis * hc_dur +  sexual_satisfaction +  sex_freq + (1| CASEID), family = binomial, data = cccu_R3_s, control=glmerControl(optimizer="bobyqa"))

R3_sa_m3_sum <- summary(R3_sa_m3)
```



####m4
```{r}
#filter for first measurement occasion
length(unique(cccu_SA$CASEID))


cccu_SA_sens = cccu_SA %>%
  group_by(CASEID) %>%
  arrange(WAVE) %>%
  mutate(count = row_number()) %>%
  ungroup()

cccu_SA_sens = cccu_SA_sens %>%
  filter(count == 1)


#repeating model 3 as linear model 
sa_m3_lm <- glm(switch ~ contra_satis* hc_dur  +  sexual_satisfaction +  sex_freq, family = binomial, data = cccu_SA_sens)

sa_m3_lm_sum <- summary(sa_m3_lm)

#model 4 as linear model (did not converge otherwise)

sa_m4_lm <- glm(switch ~ contra_satis*hc_dur +  sexual_satisfaction +   sex_freq + AGE + DEGREE_recode + POVRATE + HLTHPROB_recode + MEDPROB_recode + GAPINS_recode +
              TYPEINS_recode + NKIDS_t1 +  pregnant_between_waves + had_baby_between_waves+ Avoid_r + FEELPG_recode +
              rel_dur_factor,
            family = binomial,
            data = cccu_SA_sens)

sa_m4_lm_sum <- summary(sa_m4_lm)
```

####m3lm and m4lm in robustnessanalyses
```{r}
#filter for first measurement occasion
length(unique(cccu_R1_s$CASEID))


cccu_R1_SA_sens = cccu_R1_s %>%
  group_by(CASEID) %>%
  arrange(WAVE) %>%
  mutate(count = row_number()) %>%
  ungroup()

cccu_R1_SA_sens = cccu_R1_SA_sens %>%
  filter(count == 1)



#filter for first measurement occasion
length(unique(cccu_R2_s$CASEID))


cccu_R2_SA_sens = cccu_R1_s %>%
  group_by(CASEID) %>%
  arrange(WAVE) %>%
  mutate(count = row_number()) %>%
  ungroup()

cccu_R2_SA_sens = cccu_R2_SA_sens %>%
  filter(count == 1)


#filter for first measurement occasion
length(unique(cccu_R3_s$CASEID))


cccu_R3_SA_sens = cccu_R3_s %>%
  group_by(CASEID) %>%
  arrange(WAVE) %>%
  mutate(count = row_number()) %>%
  ungroup()

cccu_R3_SA_sens = cccu_R3_SA_sens %>%
  filter(count == 1)



R1_sa_m3_lm <- glm(switch ~ contra_satis* hc_dur  +  sexual_satisfaction +  sex_freq, family = binomial, data = cccu_R1_SA_sens)

R1_sa_m3_lm_sum <- summary(R1_sa_m3_lm)



R2_sa_m3_lm <- glm(switch ~ contra_satis* hc_dur  +  sexual_satisfaction +  sex_freq, family = binomial, data = cccu_R2_SA_sens)

R2_sa_m3_lm_sum <-summary(R2_sa_m3_lm)


R3_sa_m3_lm <- glm(switch ~ contra_satis* hc_dur  +  sexual_satisfaction +  sex_freq, family = binomial, data = cccu_R3_SA_sens)

R3_sa_m3_lm_sum <-summary(R3_sa_m3_lm)





#model 4
R1_sa_m4_lm <- glm(switch ~ contra_satis*hc_dur +  sexual_satisfaction +   sex_freq + AGE + DEGREE_recode + POVRATE + HLTHPROB_recode + MEDPROB_recode + GAPINS_recode +
              TYPEINS_recode + NKIDS_t1 +  pregnant_between_waves + had_baby_between_waves+ Avoid_r + FEELPG_recode +
              rel_dur_factor,
            family = binomial,
            data = cccu_R1_SA_sens)

R1_sa_m4_lm_sum <- summary(R1_sa_m4_lm)



R2_sa_m4_lm <- glm(switch ~ contra_satis*hc_dur +  sexual_satisfaction +   sex_freq + AGE + DEGREE_recode + POVRATE + HLTHPROB_recode + MEDPROB_recode + GAPINS_recode +
              TYPEINS_recode + NKIDS_t1 +  pregnant_between_waves + had_baby_between_waves+ Avoid_r + FEELPG_recode +
              rel_dur_factor,
            family = binomial,
            data = cccu_R2_SA_sens)

R2_sa_m4_lm_sum <- summary(R2_sa_m4_lm)



R3_sa_m4_lm <- glm(switch ~ contra_satis*hc_dur +  sexual_satisfaction +   sex_freq + AGE + DEGREE_recode + POVRATE + HLTHPROB_recode + MEDPROB_recode + GAPINS_recode +
              TYPEINS_recode + NKIDS_t1 +  pregnant_between_waves + had_baby_between_waves+ Avoid_r + FEELPG_recode +
              rel_dur_factor,
            family = binomial,
            data = cccu_R3_SA_sens)

R3_sa_m4_lm_sum <- summary(R3_sa_m4_lm)


```



### Effects and CIs
####m2
```{r}
sa_m2_confint = confint(sa_m2, method = "Wald", level = .997) 

rn = rownames(sa_m2_confint)
sa_m2_confint = data.frame(sa_m2_confint)

colnames(sa_m2_confint) = c("lower", "upper")
sa_m2_confint$predictor = rn


sa_m2_forest_plot = data.frame(
  predictor = names(sa_m2_sum$coefficients[,1]),
  estimate = as.numeric(as.character(sa_m2_sum$coefficients[,1])))

sa_m2_forest_plot = left_join(sa_m2_forest_plot, sa_m2_confint, by = "predictor")

sa_m2_forest_plot$group = rep("sa_multilevel_model_2", 2)

```


#m2 in Robustnessanalyses
```{r}
#r1
R1_sa_m2_confint = confint(R1_sa_m2, method = "Wald", level = .997) 

rn = rownames(R1_sa_m2_confint)
R1_sa_m2_confint = data.frame(R1_sa_m2_confint)

colnames(R1_sa_m2_confint) = c("lower", "upper")
R1_sa_m2_confint$predictor = rn


R1_sa_m2_forest_plot = data.frame(
  predictor = names(R1_sa_m2_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R1_sa_m2_sum$coefficients[,1])))

R1_sa_m2_forest_plot = left_join(R1_sa_m2_forest_plot, R1_sa_m2_confint, by = "predictor")

R1_sa_m2_forest_plot$group = rep("R1_sa_multilevel_model_2", 2)


#r2
#R2
R2_sa_m2_confint = confint(R2_sa_m2, method = "Wald", level = .997) 

rn = rownames(R2_sa_m2_confint)
R2_sa_m2_confint = data.frame(R2_sa_m2_confint)

colnames(R2_sa_m2_confint) = c("lower", "upper")
R2_sa_m2_confint$predictor = rn


R2_sa_m2_forest_plot = data.frame(
  predictor = names(R2_sa_m2_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R2_sa_m2_sum$coefficients[,1])))

R2_sa_m2_forest_plot = left_join(R2_sa_m2_forest_plot, R2_sa_m2_confint, by = "predictor")

R2_sa_m2_forest_plot$group = rep("R2_sa_multilevel_model_2", 2)


#r3
#R3
R3_sa_m2_confint = confint(R3_sa_m2, method = "Wald", level = .997) 

rn = rownames(R3_sa_m2_confint)
R3_sa_m2_confint = data.frame(R3_sa_m2_confint)

colnames(R3_sa_m2_confint) = c("lower", "upper")
R3_sa_m2_confint$predictor = rn


R3_sa_m2_forest_plot = data.frame(
  predictor = names(R3_sa_m2_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R3_sa_m2_sum$coefficients[,1])))

R3_sa_m2_forest_plot = left_join(R3_sa_m2_forest_plot, R3_sa_m2_confint, by = "predictor")

R3_sa_m2_forest_plot$group = rep("R3_sa_multilevel_model_2", 2)

```

####m3
```{r}
sa_m3_confint = confint(sa_m3, method = "Wald", level = .997) 

rn = rownames(sa_m3_confint)
sa_m3_confint = data.frame(sa_m3_confint)


colnames(sa_m3_confint) = c("lower", "upper")
sa_m3_confint$predictor <- rn


sa_m3_forest_plot = data.frame(
  predictor = names(sa_m3_sum$coefficients[,1]),
  estimate = as.numeric(as.character(sa_m3_sum$coefficients[,1])))

sa_m3_forest_plot = left_join(sa_m3_forest_plot, sa_m3_confint, by = "predictor")

sa_m3_forest_plot$group = rep("sa_multilevel_model_3", 2)

```

#m3 in robustness analyses
```{r}
#r1
R1_sa_m3_confint = confint(R1_sa_m3, method = "Wald", level = .997) 

rn = rownames(R1_sa_m3_confint)
R1_sa_m3_confint = data.frame(R1_sa_m3_confint)

colnames(R1_sa_m3_confint) = c("lower", "upper")
R1_sa_m3_confint$predictor = rn


R1_sa_m3_forest_plot = data.frame(
  predictor = names(R1_sa_m3_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R1_sa_m3_sum$coefficients[,1])))

R1_sa_m3_forest_plot = left_join(R1_sa_m3_forest_plot, R1_sa_m3_confint, by = "predictor")

R1_sa_m3_forest_plot$group = rep("R1_sa_multilevel_model_3", 2)


#r2
#R2
R2_sa_m3_confint = confint(R2_sa_m3, method = "Wald", level = .997) 

rn = rownames(R2_sa_m3_confint)
R2_sa_m3_confint = data.frame(R2_sa_m3_confint)

colnames(R2_sa_m3_confint) = c("lower", "upper")
R2_sa_m3_confint$predictor = rn


R2_sa_m3_forest_plot = data.frame(
  predictor = names(R2_sa_m3_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R2_sa_m3_sum$coefficients[,1])))

R2_sa_m3_forest_plot = left_join(R2_sa_m3_forest_plot, R2_sa_m3_confint, by = "predictor")

R2_sa_m3_forest_plot$group = rep("R2_sa_multilevel_model_3", 2)


#r3
#R3
R3_sa_m3_confint = confint(R3_sa_m3, method = "Wald", level = .997) 

rn = rownames(R3_sa_m3_confint)
R3_sa_m3_confint = data.frame(R3_sa_m3_confint)

colnames(R3_sa_m3_confint) = c("lower", "upper")
R3_sa_m3_confint$predictor = rn


R3_sa_m3_forest_plot = data.frame(
  predictor = names(R3_sa_m3_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R3_sa_m3_sum$coefficients[,1])))

R3_sa_m3_forest_plot = left_join(R3_sa_m3_forest_plot, R3_sa_m3_confint, by = "predictor")

R3_sa_m3_forest_plot$group = rep("R3_sa_multilevel_model_3", 2)

```


####m3 linear
```{r}
sa_m3_lm_confint = confint(sa_m3_lm, method = "Wald", level = .997) 

rn = rownames(sa_m3_lm_confint)
sa_m3_lm_confint = data.frame(sa_m3_lm_confint)

colnames(sa_m3_lm_confint) = c("lower", "upper")
sa_m3_lm_confint$predictor = rn


sa_m3_lm_forest_plot = data.frame(
  predictor = names(sa_m3_lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(sa_m3_lm_sum$coefficients[,1])))

sa_m3_lm_forest_plot = left_join(sa_m3_lm_forest_plot, sa_m3_lm_confint, by = "predictor")

sa_m3_lm_forest_plot$group = rep("sa_model_3", 2)

```
####linear model 3 in robustenss analyses
```{r}
#r1
R1_sa_m3_lm_confint = confint(R1_sa_m3_lm, method = "Wald", level = .997) 

rn = rownames(R1_sa_m3_lm_confint)
R1_sa_m3_lm_confint = data.frame(R1_sa_m3_lm_confint)

colnames(R1_sa_m3_lm_confint) = c("lower", "upper")
R1_sa_m3_lm_confint$predictor = rn


R1_sa_m3_lm_forest_plot = data.frame(
  predictor = names(R1_sa_m3_lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R1_sa_m3_lm_sum$coefficients[,1])))

R1_sa_m3_lm_forest_plot = left_join(R1_sa_m3_lm_forest_plot, R1_sa_m3_lm_confint, by = "predictor")

R1_sa_m3_lm_forest_plot$group = rep("R1_sa_model_3", 2)


#r2
#R2
R2_sa_m3_lm_confint = confint(R2_sa_m3_lm, method = "Wald", level = .997) 

rn = rownames(R2_sa_m3_lm_confint)
R2_sa_m3_lm_confint = data.frame(R2_sa_m3_lm_confint)

colnames(R2_sa_m3_lm_confint) = c("lower", "upper")
R2_sa_m3_lm_confint$predictor = rn


R2_sa_m3_lm_forest_plot = data.frame(
  predictor = names(R2_sa_m3_lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R2_sa_m3_lm_sum$coefficients[,1])))

R2_sa_m3_lm_forest_plot = left_join(R2_sa_m3_lm_forest_plot, R2_sa_m3_lm_confint, by = "predictor")

R2_sa_m3_lm_forest_plot$group = rep("R2_sa_model_3", 2)


#r3
#R3
R3_sa_m3_lm_confint = confint(R3_sa_m3_lm, method = "Wald", level = .997) 

rn = rownames(R3_sa_m3_lm_confint)
R3_sa_m3_lm_confint = data.frame(R3_sa_m3_lm_confint)

colnames(R3_sa_m3_lm_confint) = c("lower", "upper")
R3_sa_m3_lm_confint$predictor = rn


R3_sa_m3_lm_forest_plot = data.frame(
  predictor = names(R3_sa_m3_lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R3_sa_m3_lm_sum$coefficients[,1])))

R3_sa_m3_lm_forest_plot = left_join(R3_sa_m3_lm_forest_plot, R3_sa_m3_lm_confint, by = "predictor")

R3_sa_m3_lm_forest_plot$group = rep("R3_sa_model_3", 2)

```

####m4 linear
```{r}
sa_m4_lm_confint = confint(sa_m4_lm, method = "Wald", level = .997) 

rn = rownames(sa_m4_lm_confint)
sa_m4_lm_confint = data.frame(sa_m4_lm_confint)

colnames(sa_m4_lm_confint) = c("lower", "upper")
sa_m4_lm_confint$predictor = rn


sa_m4_lm_forest_plot = data.frame(
  predictor = names(sa_m4_lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(sa_m4_lm_sum$coefficients[,1])))

sa_m4_lm_forest_plot = left_join(sa_m4_lm_forest_plot, sa_m4_lm_confint, by = "predictor", copy = TRUE)

sa_m4_lm_forest_plot$group = rep("sa_model_4", 37)

```

###lm4 in robustnessanalyses
```{r}
#r1
R1_sa_m4_lm_confint = confint(R1_sa_m4_lm, method = "Wald", level = .997) 

rn = rownames(R1_sa_m4_lm_confint)
R1_sa_m4_lm_confint = data.frame(R1_sa_m4_lm_confint)

colnames(R1_sa_m4_lm_confint) = c("lower", "upper")
R1_sa_m4_lm_confint$predictor = rn


R1_sa_m4_lm_forest_plot = data.frame(
  predictor = names(R1_sa_m4_lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R1_sa_m4_lm_sum$coefficients[,1])))

R1_sa_m4_lm_forest_plot = left_join(R1_sa_m4_lm_forest_plot, R1_sa_m4_lm_confint, by = "predictor")

R1_sa_m4_lm_forest_plot$group = rep("R1_sa_model_4", 37)


#r2
#R2
R2_sa_m4_lm_confint = confint(R2_sa_m4_lm, method = "Wald", level = .997) 

rn = rownames(R2_sa_m4_lm_confint)
R2_sa_m4_lm_confint = data.frame(R2_sa_m4_lm_confint)

colnames(R2_sa_m4_lm_confint) = c("lower", "upper")
R2_sa_m4_lm_confint$predictor = rn


R2_sa_m4_lm_forest_plot = data.frame(
  predictor = names(R2_sa_m4_lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R2_sa_m4_lm_sum$coefficients[,1])))

R2_sa_m4_lm_forest_plot = left_join(R2_sa_m4_lm_forest_plot, R2_sa_m4_lm_confint, by = "predictor")

R2_sa_m4_lm_forest_plot$group = rep("R2_sa_model_4", 37)



R3_sa_m4_lm_confint = confint(R3_sa_m4_lm, method = "Wald", level = .997) 

rn = rownames(R3_sa_m4_lm_confint)
R3_sa_m4_lm_confint = data.frame(R3_sa_m4_lm_confint)

colnames(R3_sa_m4_lm_confint) = c("lower", "upper")
R3_sa_m4_lm_confint$predictor = rn


R3_sa_m4_lm_forest_plot = data.frame(
  predictor = names(R3_sa_m4_lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R3_sa_m4_lm_sum$coefficients[,1])))

R3_sa_m4_lm_forest_plot = left_join(R3_sa_m4_lm_forest_plot, R3_sa_m4_lm_confint, by = "predictor")

R3_sa_m4_lm_forest_plot$group = rep("R3_sa_model_4", 37)

```


##Dataframe
```{r}
sa_forest_plot_data = rbind(sa_m2_forest_plot,R1_sa_m2_forest_plot, R2_sa_m2_forest_plot, R3_sa_m2_forest_plot, sa_m3_forest_plot,R1_sa_m3_forest_plot, R2_sa_m3_forest_plot, R3_sa_m3_forest_plot, sa_m3_lm_forest_plot,R1_sa_m3_lm_forest_plot, R2_sa_m3_lm_forest_plot, R3_sa_m3_lm_forest_plot, sa_m4_lm_forest_plot, R1_sa_m4_lm_forest_plot, R2_sa_m4_lm_forest_plot, R3_sa_m4_lm_forest_plot)

sa_forest_plot_data$predictor = factor(sa_forest_plot_data$predictor,
                                    levels = c("(Intercept)",                                               "contra_satis", "hc_dur","contra_satis:hc_dur",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times"),
                                    labels = c("(Intercept)",                                               "Contraceptive Satisfaction", "HC-Dur","Contraceptive Satisfaction:HC-Dur",
                                               "Sexual Satisfaction",
                                               "Sexual Frequency 2-5 times", "Sexual Frequency 6-10 times",
                                               "Sexual Frequency 11 or more times"))

sa_forest_plot_data$group = factor(
  sa_forest_plot_data$group,
  levels = c(
    "sa_multilevel_model_2","R1_sa_multilevel_model_2","R2_sa_multilevel_model_2","R3_sa_multilevel_model_2",
    "sa_multilevel_model_3","R1_sa_multilevel_model_3","R2_sa_multilevel_model_3","R3_sa_multilevel_model_3",
    "sa_model_3","R1_sa_model_3","R2_sa_model_3","R3_sa_model_3",
    "sa_model_4","R1_sa_model_4","R2_sa_model_4","R3_sa_model_4"
  ),
  labels = c(
    "sa_multilevel_model_2","R1_sa_multilevel_model_2","R2_sa_multilevel_model_2","R3_sa_multilevel_model_2",
    "sa_multilevel_model_3","R1_sa_multilevel_model_3","R2_sa_multilevel_model_3","R3_sa_multilevel_model_3",
    "sa_model_3","R1_sa_model_3","R2_sa_model_3","R3_sa_model_3",
    "sa_model_4","R1_sa_model_4","R2_sa_model_4","R3_sa_model_4"
  )
)



#give group for color:
sa_forest_plot_data <- sa_forest_plot_data %>%
  mutate(grouping = ifelse(group == "sa_multilevel_model_2" |group == "R1_sa_multilevel_model_2" | group == "R2_sa_multilevel_model_2" | group == "R3_sa_multilevel_model_2", "color_2",
         ifelse(group == "sa_multilevel_model_3" |group == "R1_sa_multilevel_model_3" | group == "R2_sa_multilevel_model_3" | group == "R3_sa_multilevel_model_3" ,"color_3",
                
                ifelse(group == "sa_model_3" |group == "R1_sa_model_3" | group == "R2_sa_model_3" | group == "R3_sa_model_3", "color_4", ifelse(group == "sa_model_4" |group == "R1_sa_model_4" | group == "R2_sa_model_4" | group == "R3_sa_model_4", "color_5",NA))))) 


#give group for shape:
sa_forest_plot_data <- sa_forest_plot_data %>%
  mutate(shape = ifelse(group ==  "sa_multilevel_model_1"|
  group == "sa_multilevel_model_2" |
    group == "sa_multilevel_model_3"|
    group == "sa_model_3" |
    group == "sa_model_4", "shape_1",
  ifelse(group %contains% "R1", "shape_2",
         ifelse(group %contains% "R2", "shape_3",
                ifelse(group %contains% "R3", "shape_4", NA)))))


```

##forest plot
```{r}
#forest plot including robustness analyses

#set colors
group.color <- c("yellow","green", "blue", "red")


forest_sa <- ggplot(
  data = sa_forest_plot_data %>%
    filter(predictor != "(Intercept)"),
  aes(
    x = predictor,
    y = estimate,
    group = grouping,
    fill = grouping,
    color = grouping,
    group = forcats::fct_rev(grouping),
    fill = forcats::fct_rev(grouping),
    color = forcats::fct_rev(grouping),
    shape = shape
  )
) +
  geom_point(position = position_dodge(width = 0.9),
             aes(shape = shape),
             alpha = 0.08) +
  geom_pointrange(aes(ymin = lower, ymax = upper),
                  alpha = 0.5,
                  position = position_dodge(width = 0.9)) +
  scale_x_discrete(limits = rev, expand = c(0.002, 0)) + scale_y_continuous(limits = c(-2,2),
                     breaks = seq(-2,2,1)) +
  geom_hline(yintercept = 0) +
  coord_flip() +
  scale_fill_manual(
    name = "Model",
    breaks = c("color_2", "color_3", "color_4", "color_5"),
    labels = c(
      "Multilevel Model 2",
      "Multilevel Model 3",
      "Simple Regression Model 3",
      "Simple Regression Model 4"
    ),
    values = group.color
  ) +
  scale_colour_manual(
    name = "Model",
    breaks = c("color_2", "color_3", "color_4", "color_5"),
    labels = c(
      "Multilevel Model 2",
      "Multilevel Model 3",
      "Simple Regression Model 3",
      "Simple Regression Model 4"
    ),
    values = group.color
  ) +
  scale_shape_manual(
    name = "Analyses",
    values = c(21,22,24,25),
    labels = c(
      "Normal Analyses",
      "Robustness Analyses 1",
      "Robustness Analyses 2",
      "Robustness Analyses 3"
    )
  ) +
  labs(y = "Effect Size", x = "Predictor") +
  
  apatheme

forest_sa


ggsave("forest_sa.pdf", forest_sa,  width = 23, height = 12, units = "cm", dpi = 300)
ggsave("forest_sa.png", forest_sa,  width = 23, height = 12, units = "cm", dpi = 300)

```

