---
title: "06_Main Analysis"
author: "Chiara Draxler"
date: "24 1 2022"
output: html_document
---

#1. Load Data
```{r}
load("cccu_MA.RData")
```


#2. Load Packages
```{r}
library(formr)
library(effects)
library(EValue)
library(lme4)
library(psych)
library(dplyr)
library(tidyverse)
library(patchwork)
library(marginaleffects)
```

#3. Models

##3.1 Model 1: basic model
```{r}
m1 <- glmer(switch ~ hc + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))

summary(m1)
confint(m1, method = "Wald", level = .997)
plot(allEffects(m1))


```


##3.2 Model 2: including directly with contraceptive method associated predictors
```{r}
m2 <- glmer(switch ~ hc*contra_satis + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))

summary(m2)
confint(m2, method = "Wald", level = .997)
plot(allEffects(m2))
```


##3.3 Model 3: including not directly with contraceptive method associated predictors
```{r}
m3 <- glmer(switch ~ hc * contra_satis +  hc * sexual_satisfaction + hc * sex_freq + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))

summary(m3)
confint(m3, method = "Wald", level = .997)
plot(allEffects(m3))
```

##3.4 Model 4: Controlling for observed selection effects
```{r}
#repeat model 3 for sensitivity analysis
m3 <- glm(switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq,
          family = binomial,
          data = cccu_MA)
summary(m3)
plot(allEffects(m3))

#model 4 as linear model (bc did not converge otherwise)

m4 <- glm(switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq + hc *AGE + hc *DEGREE_recode + hc *POVRATE +
              hc *HLTHPROB_recode + hc *MEDPROB_recode +  hc *GAPINS_recode +
              hc *TYPEINS_recode + hc *NKIDS_t1 +  hc *pregnant_between_waves + hc *had_baby_between_waves+ hc *Avoid_r + hc *FEELPG_recode +
              hc *rel_dur_factor,
            family = binomial,
            data = cccu_MA)
summary(m4)
confint(m4, method = "Wald", level = .997)
plot(allEffects(m4))
```

#Senstivity analysis after m4: controlling for unobserved selection effects
```{r}

library(lme4)
exp(m4$coefficients)
exp(confint(m4, method = "Wald", level = .997))


#sensitivity analysis for contra_satis
evalue(OR(5.629007e-01,rare=FALSE),lo= 4.379552e-01,  hi=6.702586e-01)

#for interaction hc:contra_satis
evalue(OR(1.418598e+00,rare=FALSE),lo= 8.901014e-01,  hi=2.289899e+00)
```


#Average marginal effects
#m1
##predict values
```{r}



#grid = cccu_MA %>%
  data_grid(hc)

#data_pred = add_epred_draws(grid, m1,
                #   value = "E[y|A,B]",
                 #  ndraws = 1000)


#add predicted values
data_pred<-predictions(m1) |> head()
#contrasts
cmp <- comparisons(m1)
#average marginal effect
summary(cmp)
ame <- marginaleffects(m1)
summary(ame)


```

#m2
```{r}
#add predicted values
predictions(m2) |> head()
#contrasts
cmp <- comparisons(m2)
#average marginal effect
summary(cmp)
ame <- marginaleffects(m2)
summary(ame)
```

#m3
```{r}
#add predicted values
predictions(m3) |> head()
#contrasts
cmp <- comparisons(m3)
#average marginal effect
summary(cmp)
ame <- marginaleffects(m3)
summary(ame)
```

#m4
```{r}
#add predicted values
predictions(m4) |> head()
#contrasts
cmp <- comparisons(m4)
#average marginal effect
summary(cmp)
ame <- marginaleffects(m4)
summary(ame)

```


