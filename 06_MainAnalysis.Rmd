---
title: "06_Main Analysis"
author: "Chiara Draxler"
date: "24 1 2022"
output: html_document
---

#1. Load Data
```{r}
load("cccu_MA.RData")
```


#2. Load Packages
```{r}
library(formr)
library(effects)
library(EValue)
library(lme4)
library(psych)
library(dplyr)
library(tidyverse)
library(patchwork)
library(marginaleffects)

options(scipen=999)
```

#3. Models

##3.1 Model 1: basic model
```{r}
m1 <- glmer(switch ~ hc + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))

summary(m1)
confint(m1, method = "Wald", level = .997)
plot(allEffects(m1))


```


##3.2 Model 2: including directly with contraceptive method associated predictors
```{r}
m2 <- glmer(switch ~ hc*contra_satis + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))

summary(m2)
confint(m2, method = "Wald", level = .997)
plot(allEffects(m2))
```


##3.3 Model 3: including not directly with contraceptive method associated predictors
```{r}
m3 <- glmer(switch ~ hc * contra_satis +  hc * sexual_satisfaction + hc * sex_freq + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))

summary(m3)
confint(m3, method = "Wald", level = .997)
plot(allEffects(m3))
```

##3.4 Model 4: Controlling for observed selection effects
```{r}

#filter for first measurement occasion
length(unique(cccu_MA$CASEID))


cccu_MA_sens = cccu_MA %>%
  group_by(CASEID) %>%
  arrange(WAVE) %>%
  mutate(count = row_number()) %>%
  ungroup()

cccu_MA_sens = cccu_MA_sens %>%
  filter(count == 1)

table(cccu_MA_sens$WAVE)

#repeat model 3 for sensitivity analyses
m3_lm = glm(switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq,
          family = binomial,
          data = cccu_MA_sens)
summary(m3_lm)

m4_lm = glm(switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq + hc *AGE + hc *DEGREE_recode +
              hc *POVRATE +
              hc *HLTHPROB_recode + hc *MEDPROB_recode +  hc *GAPINS_recode +
              hc *TYPEINS_recode + hc *NKIDS_t1 +  hc *pregnant_between_waves + hc *had_baby_between_waves+ hc *Avoid_r +
              hc *FEELPG_recode +
              hc *rel_dur_factor,
            family = binomial,
            data = cccu_MA_sens)
summary(m4_lm)



confint(m4_lm, method = "Wald", level = .997)
plot(allEffects(m4_lm))
```



###Average marginal effects
####m1
```{r}
#average marginal effect
ame <- marginaleffects(m1)
summary(ame)


```

####m2
```{r}
#average marginal effect
ame <- marginaleffects(m2)
summary(ame)

m2_hc_only <- glmer(switch ~ contra_satis + (1| CASEID),
                    family = binomial,
                    data = cccu_MA %>% filter(hc == "hc"),
                    control=glmerControl(optimizer="bobyqa"))
ame <- marginaleffects(m2_hc_only)
summary(ame)

m2_nonhc_only <- glmer(switch ~ contra_satis + (1| CASEID),
                    family = binomial,
                    data = cccu_MA %>% filter(hc == "non_hc"),
                    control=glmerControl(optimizer="bobyqa"))
ame <- marginaleffects(m2_nonhc_only)
summary(ame)
```

####m3
```{r}
#average marginal effect
ame <- marginaleffects(m3)
summary(ame)

m3_hc_only <- glmer(switch ~ contra_satis + sexual_satisfaction + sex_freq + 
                      (1| CASEID),
                    family = binomial,
                    data = cccu_MA %>% filter(hc == "hc"),
                    control=glmerControl(optimizer="bobyqa"))
ame <- marginaleffects(m3_hc_only)
summary(ame)


m3_nonhc_only <- glmer(switch ~ contra_satis + sexual_satisfaction + sex_freq + 
                      (1| CASEID),
                    family = binomial,
                    data = cccu_MA %>% filter(hc == "non_hc"),
                    control=glmerControl(optimizer="bobyqa"))
ame <- marginaleffects(m3_nonhc_only)
summary(ame)
```

####m4
```{r}

#average marginal effect

#model 3 lm
ame <- marginaleffects(m3_lm)
summary(ame)

#model 4
ame <- marginaleffects(m4_lm)
summary(ame)

m4_hc_only <- glm(switch ~ contra_satis + sexual_satisfaction +  sex_freq +
                    AGE + DEGREE_recode + POVRATE +
                    HLTHPROB_recode + MEDPROB_recode +  GAPINS_recode +
                    TYPEINS_recode + NKIDS_t1 +  pregnant_between_waves +
                    had_baby_between_waves + Avoid_r + FEELPG_recode +
                    rel_dur_factor,
            family = binomial,
            data = cccu_MA_sens %>% filter(hc == "hc"))

ame <- marginaleffects(m4_hc_only)
summary(ame)

m4_nonhc_only <- glm(switch ~ contra_satis + sexual_satisfaction +  sex_freq +
                    AGE + DEGREE_recode + POVRATE +
                    HLTHPROB_recode + MEDPROB_recode +  GAPINS_recode +
                    TYPEINS_recode + NKIDS_t1 +  pregnant_between_waves +
                    had_baby_between_waves + Avoid_r + FEELPG_recode +
                    rel_dur_factor,
            family = binomial,
            data = cccu_MA_sens %>% filter(hc == "non_hc"))

ame <- marginaleffects(m4_nonhc_only)
summary(ame)
```


#4. Senstivity analysis after m4: controlling for unobserved selection effects
```{r}
#repeat models first

summary(m3_lm)

summary(m4_lm)

##compute OR and CI first

#model 3 to compare e-value for unobserved / observed confounders
exp(m3_lm$coefficients)
exp(confint(m3_lm, method = "Wald", level = .997))

#model 4
exp(m4_lm$coefficients)
exp(confint(m4_lm, parm = "contra_satis", method = "Wald", level = .997))

#compute e-values

#model 3

#for contra_satis
evalue(OR(0.53722164,rare=FALSE),lo= 0.392258135,  hi=0.7352011)

#model 4
#for contra_satis
evalue(OR(0.5539576142243,rare=FALSE),lo= 0.3927306,  hi=0.7802013)

```


