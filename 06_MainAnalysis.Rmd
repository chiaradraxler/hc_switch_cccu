---
title: "06_Main Analysis"
author: "Chiara Draxler"
date: "24 1 2022"
output: html_document
---

#1. Load Data
```{r}
load("cccu_MA.RData")
```


#2. Load Packages
```{r}
library(formr)
library(effects)
library(lme4)
library(psych)
library(dplyr)
```

##Outliers
```{r}

#see outliers
boxplot(cccu_MA$AGE)$out #no
boxplot(cccu_MA$hc)$out #no
boxplot(cccu_MA$contra_satis)$out #outlier!!!

boxplot(cccu_MA$sexual_satisfaction)$out #no
boxplot(cccu_MA$sex_freq)$out#outlier! but no trimming possible bc factor



boxplot(cccu_MA$AGE)$out #no
boxplot(cccu_MA$DEGREE_recode)$out#outlier! but no trimming possible bc factor
boxplot(cccu_MA$POVRATE)$out#outlier

boxplot(cccu_MA$HLTHPROB_recode)$out#outlier but no trimming possible bc factor

boxplot(cccu_MA$MEDPROB_recode)$out#outlier but no trimming possible bc factor
boxplot(cccu_MA$GAPINS_recode)$out#outlier but no trimming possible bc factor
boxplot(cccu_MA$TYPEINS_recode)$out#outlier but no trimming possible bc factor

boxplot(cccu_MA$NKIDS_t1)$out

boxplot(cccu_MA$pregnant_between_waves)$out#outlier but no trimming possible bc factor
boxplot(cccu_MA$had_baby_between_waves)$out#outlier but no trimming possible bc factor

boxplot(cccu_MA$Avoid_r)$out

boxplot(cccu_MA$FEELPG_recode)$out
boxplot(cccu_MA$rel_dur_factor)$out


#dealing with outliers

##contra_satis
cccu_MA <- cccu_MA %>%
  mutate(contra_satis_trim = ifelse(contra_satis > (mean(contra_satis)+3*sd(contra_satis)), mean(contra_satis), contra_satis))
describe(cccu_MA$contra_satis)
cccu_MA %>% select(CASEID, WAVE, contra_satis_trim, contra_satis) %>% View()

##povrate

cccu_MA <- cccu_MA %>%
  mutate(POVRATE_trim = ifelse(POVRATE > (mean(POVRATE)+3*sd(POVRATE)), mean(POVRATE), POVRATE))
describe(cccu_MA$POVRATE)
cccu_MA %>% select(CASEID, WAVE, POVRATE_trim, POVRATE) %>% View()

table(cccu_MA$TYPEINS_recode)
```


#3. Models

##3.1 Model 1: basic model
```{r}
m1 <- glmer(switch ~ hc + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))

summary(m1)
confint(m1, method = "Wald", level = .997)
plot(allEffects(m1))
```


##3.2 Model 2: including directly with contraceptive method associated predictors
```{r}
m2 <- glmer(switch ~ hc*contra_satis + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))

summary(m2)
confint(m2, method = "Wald", level = .997)
plot(allEffects(m2))
```


##3.3 Model 3: including not directly with contraceptive method associated predictors
```{r}
m3 <- glmer(switch ~ hc * contra_satis +  hc * sexual_satisfaction + hc * sex_freq  + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))

summary(m3)
confint(m3, method = "Wald", level = .997)
plot(allEffects(m3))
```

##3.4 Model 4: Controlling for observed selection effects
```{r}
m4 <- glmer(switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq + hc *AGE + hc *DEGREE_recode + hc *POVRATE + hc *HLTHPROB_recode + hc *MEDPROB_recode +  hc *GAPINS_recode +
              hc *TYPEINS_recode + hc *NKIDS_t1 +  hc *pregnant_between_waves + hc *had_baby_between_waves+ hc *Avoid_r + hc *FEELPG_recode + hc *rel_dur_factor + (1| CASEID),
            family = binomial,
            data = cccu_MA)

summary(m4)
confint(m4, method = "Wald", level = .997)
plot(allEffects(m4))
```


## Optimizer
```{r}
# install.packages("afex")
# library(afex)

allFit(show.meth.tab=TRUE) 
gm_all <- allFit(m4)
```


