---
title: "09_plots"
output: html_document
date: '2022-06-28'
---

##1. Load Data
```{r}
load("cccu_MA.RData")
```


##2. Load Packages
```{r}
library(formr)
library(effects)
library(EValue)
library(lme4)
library(psych)
library(dplyr)
library(tidyverse)
library(patchwork)
library(marginaleffects)

options(scipen=999)

apatheme=theme_bw()+
    theme(panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          panel.border=element_blank(),
          axis.line=element_line(),
          text=element_text(family='Times'))
```


## 3. Specific effects
Plots for
- hc*contra_satis
- hc*sexual_satisfaction
- hc*sex_freq
- hc_dur*contra_satis
based on multilevel model m3
```{r}
m3 <- glmer(switch ~ hc * contra_satis +  hc * sexual_satisfaction + hc * sex_freq + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))

plot(effect(term = "hc * contra_satis", mod = m3, confidence.level = 0.997))

eff = allEffects(mod = m3, confidence.level = 0.997)

eff_contra_satis = eff$`hc:contra_satis`

eff_contra_satis_datplot = data.frame(
  hc = eff_contra_satis$x$hc,
  contra_satis = eff_contra_satis$x$contra_satis,
  estimate = eff_contra_satis$fit,
  lower = eff_contra_satis$lower,
  upper = eff_contra_satis$upper)


ggplot(data = eff_contra_satis_datplot,
       aes(x = contra_satis, y = estimate, group = hc, color = hc, fill = hc)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = hc), 
              alpha=0.1) +
  apatheme


eff_sexual_satisfaction = eff$`hc:sexual_satisfaction`

eff_sexual_satisfaction_datplot = data.frame(
  hc = eff_sexual_satisfaction$x$hc,
  sex_sat = eff_sexual_satisfaction$x$sexual_satisfaction,
  estimate = eff_sexual_satisfaction$fit,
  lower = eff_sexual_satisfaction$lower,
  upper = eff_sexual_satisfaction$upper)


eff_sex_freq = eff$`hc:sex_freq`
```

## 4. Forest plot
for model m3_lm and m4_lm
```{r}
#filter for first measurement occasion
length(unique(cccu_MA$CASEID))


cccu_MA_sens = cccu_MA %>%
  group_by(CASEID) %>%
  arrange(WAVE) %>%
  mutate(count = row_number()) %>%
  ungroup()

cccu_MA_sens = cccu_MA_sens %>%
  filter(count == 1)

table(cccu_MA_sens$WAVE)

#repeat model 3 for sensitivity analyses
m3_lm = glm(switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq,
          family = binomial,
          data = cccu_MA_sens)
summary(m3_lm)
m3_lm_confint = confint(m3_lm, method = "Wald", level = .997) 

rn = rownames(m3_lm_confint)
m3_lm_confint = data.frame(m3_lm_confint)

colnames(m3_lm_confint) = c("lower", "upper")
m3_lm_confint$predictor = rn


forest_plot_data = data.frame(
  predictor = names(m3_lm$coefficients),
  estimate = as.numeric(as.character(m3_lm$coefficients)))

forest_plot_data = left_join(forest_plot_data, m3_lm_confint, by = "predictor")

forest_plot_data$group = rep("model_3", 12)

forest_plot_data$predictor = factor(forest_plot_data$predictor,
                                    levels = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                               "hcnon_hc:contra_satis",
                                               "hcnon_hc:sexual_satisfaction",
                                               "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"),
                                    labels = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                               "hcnon_hc:contra_satis",
                                               "hcnon_hc:sexual_satisfaction",
                                               "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"))



m4_lm = glm(switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq + hc *AGE + hc *DEGREE_recode +
              hc *POVRATE +
              hc *HLTHPROB_recode + hc *MEDPROB_recode +  hc *GAPINS_recode +
              hc *TYPEINS_recode + hc *NKIDS_t1 +  hc *pregnant_between_waves + hc *had_baby_between_waves+ hc *Avoid_r +
              hc *FEELPG_recode +
              hc *rel_dur_factor,
            family = binomial,
            data = cccu_MA_sens)

m4_lm_confint = confint(m4_lm, parm = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                               "hcnon_hc:contra_satis",
                                               "hcnon_hc:sexual_satisfaction",
                                               "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"),
                        method = "Wald", level = .997) 

rn = rownames(m4_lm_confint)
m4_lm_confint = data.frame(m4_lm_confint)

colnames(m4_lm_confint) = c("lower", "upper")
m4_lm_confint$predictor = rn


forest_plot_data2 = data.frame(
  predictor = names(m4_lm$coefficients),
  estimate = as.numeric(as.character(m4_lm$coefficients)))

forest_plot_data2 = left_join(forest_plot_data2, m4_lm_confint, by = "predictor")

forest_plot_data2$group = rep("model_4", 12)

forest_plot_data = rbind(forest_plot_data, forest_plot_data2)
forest_plot_data$predictor = factor(forest_plot_data$predictor,
                                    levels = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                               "hcnon_hc:contra_satis",
                                               "hcnon_hc:sexual_satisfaction",
                                               "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"),
                                    labels = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                               "hcnon_hc:contra_satis",
                                               "hcnon_hc:sexual_satisfaction",
                                               "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"))




ggplot(data = forest_plot_data %>%
         filter(predictor != "(Intercept)"),
       aes(x = predictor,
           y = estimate,
           group = group,
           fill = group,
           color = group)) +
  geom_point(position = position_dodge(width=-0.3)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width=-0.3)) +
  scale_x_discrete(limits=rev) +
  geom_hline(yintercept = 1) +
  coord_flip() +
  apatheme






m3_lm_confint = confint(m3_lm, method = "Wald", level = .997)

confint(m4_lm, method = "Wald", level = .997)
```

