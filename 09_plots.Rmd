---
title: "09_plots"
output: html_document
date: '2022-06-28'
---

#1. Load Data
```{r}
load("cccu_MA.RData")
```


#2. Load Packages
```{r}
library(formr)
library(effects)
library(EValue)
library(lme4)
library(psych)
library(dplyr)
library(tidyverse)
library(patchwork)
library(marginaleffects)

options(scipen=999)

apatheme=theme_bw()+
    theme(panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          panel.border=element_blank(),
          axis.line=element_line(),
          text=element_text(family='Times'))
```


##3.3 Model 3: including not directly with contraceptive method associated predictors
```{r}
m3 <- glmer(switch ~ hc * contra_satis +  hc * sexual_satisfaction + hc * sex_freq + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))

plot(effect(term = "hc * contra_satis", mod = m3, confidence.level = 0.997))

eff = allEffects(mod = m3, confidence.level = 0.997)

eff_contra_satis = eff$`hc:contra_satis`

eff_contra_satis_datplot = data.frame(
  hc = eff_contra_satis$x$hc,
  contra_satis = eff_contra_satis$x$contra_satis,
  estimate = eff_contra_satis$fit,
  lower = eff_contra_satis$lower,
  upper = eff_contra_satis$upper)


ggplot(data = eff_contra_satis_datplot,
       aes(x = contra_satis, y = estimate, group = hc, color = hc, fill = hc)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = hc), 
              alpha=0.1) +
  apatheme


eff_sexual_satisfaction = eff$`hc:sexual_satisfaction`

eff_sexual_satisfaction_datplot = data.frame(
  hc = eff_sexual_satisfaction$x$hc,
  sex_sat = eff_sexual_satisfaction$x$sexual_satisfaction,
  estimate = eff_sexual_satisfaction$fit,
  lower = eff_sexual_satisfaction$lower,
  upper = eff_sexual_satisfaction$upper)


eff_sex_freq = eff$`hc:sex_freq`
```