---
title: "09_plots"
output: html_document
date: '2022-06-28'
---

##1. Load Data
```{r}
load("cccu_MA.RData")
load("cccu_SA.RData")
load("cccu_R1.RData")
load("cccu_R2.RData")
load("cccu_R3.RData")
```


##2. Load Packages
```{r}
library(formr)
library(effects)
library(EValue)
library(lme4)
library(psych)
library(dplyr)
library(tidyverse)
library(patchwork)
library(marginaleffects)
library(ggpubr)
library(RColorBrewer)



options(scipen=999)

apatheme=theme_bw()+
    theme(panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          panel.border=element_blank(),
          axis.line=element_line(),
          text=element_text(family='Times'))
```


## 3. Specific effects
Plots for
- hc*contra_satis
- hc*sexual_satisfaction
- hc*sex_freq
- hc_dur*contra_satis
based on multilevel model m3
```{r}
m3 <- glmer(switch ~ hc * contra_satis +  hc * sexual_satisfaction + hc * sex_freq + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))

plot(effect(term = "hc * contra_satis", mod = m3, confidence.level = 0.997))

eff = allEffects(mod = m3, confidence.level = 0.997)

#contraceptive satisfaction

eff_contra_satis = eff$`hc:contra_satis`

eff_contra_satis_datplot = data.frame(
  hc = eff_contra_satis$x$hc,
  contra_satis = eff_contra_satis$x$contra_satis,
  estimate = eff_contra_satis$fit,
  lower = eff_contra_satis$lower,
  upper = eff_contra_satis$upper)


plot_contra_satis <- ggplot(data = eff_contra_satis_datplot,
                            aes(
                              x = contra_satis,
                              y = estimate,
                              group = hc,
                              color = hc,
                              fill = hc
                            )) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = hc),
              alpha = 0.07) +
  labs(color = "Group",  fill = "Group") +
  scale_fill_manual(
    values = c("red", "blue"),
    name = "Group",
    breaks = c("hc", "non_hc"),
    labels = c(
      "Hormonal Contraceptive Users",
      "Non-Hormonal Contraceptive Users"
    ),
  ) +
  scale_colour_manual(
    values = c("red", "blue"),
    name  = "Group",
    breaks = c("hc", "non_hc"),
    labels = c(
      "Hormonal Contraceptive Users",
      "Non-Hormonal Contraceptive Users"
    )
  ) +
  labs(y = "Probability to Switch") +
  scale_x_discrete("Contraceptive Satisfaction",
                   limits = c("1", "2", "3", "4")) +
  
  apatheme

plot_contra_satis

#sexual satisfaction

eff_sexual_satisfaction = eff$`hc:sexual_satisfaction`

eff_sexual_satisfaction_datplot = data.frame(
  hc = eff_sexual_satisfaction$x$hc,
  sex_sat = eff_sexual_satisfaction$x$sexual_satisfaction,
  estimate = eff_sexual_satisfaction$fit,
  lower = eff_sexual_satisfaction$lower,
  upper = eff_sexual_satisfaction$upper)



plot_sexual_satisfaction <-
  ggplot(data = eff_sexual_satisfaction_datplot,
         aes(
           x = sex_sat,
           y = estimate,
           group = hc,
           color = hc,
           fill = hc
         )) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = hc),
              alpha = 0.07) +
  labs(color = "Group",  fill = "Group") +
  scale_fill_manual(
    values = c("red", "blue"),
    name = "Group",
    breaks = c("hc", "non_hc"),
    labels = c(
      "Hormonal Contraceptive Users",
      "Non-Hormonal Contraceptive Users"
    )
  ) +
  scale_colour_manual(
    values = c("red", "blue"),
    name  = "Group",
    breaks = c("hc", "non_hc"),
    labels = c(
      "Hormonal Contraceptive Users",
      "Non-Hormonal Contraceptive Users"
    )
  ) +
  labs(y = "Probability to Switch") +
  scale_x_discrete("Sexual Satisfaction",
                   limits = c("1", "2", "3", "4", "5", "6")) +
  
  apatheme


    
plot_sexual_satisfaction

#sexual frequency 

eff_sex_freq = eff$`hc:sex_freq`

eff_sex_freq_datplot = data.frame(
  hc = eff_sex_freq$x$hc,
  sex_freq = eff_sex_freq$x$sex_freq,
  estimate = eff_sex_freq$fit,
  lower = eff_sex_freq$lower,
  upper = eff_sex_freq$upper)


plot_sex_freq <- ggplot(data = eff_sex_freq_datplot,
                        aes(
                          x = sex_freq,
                          y = estimate,
                          group = hc,
                          color = hc,
                          fill = hc
                        )) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = hc),
              alpha = 0.07) +
  labs(color = "Group",  fill = "Group") +
  scale_fill_manual(
    values = c("red", "blue"),
    name = "Group",
    breaks = c("hc", "non_hc"),
    labels = c(
      "Hormonal Contraceptive Users",
      "Non-Hormonal Contraceptive Users"
    )
  ) +
  scale_colour_manual(
    values = c("red", "blue"),
    name  = "Group",
    breaks = c("hc", "non_hc"),
    labels = c(
      "Hormonal Contraceptive Users",
      "Non-Hormonal Contraceptive Users"
    )
  ) +
  labs(y = "Probability to Switch") +
  scale_x_discrete(
    "Sexual Frequency",
    limits = c("No sex or once", "2-5 times","6-10 times", "11 or more times")
  ) +
  apatheme

plot_sex_freq

#for hc dur

sa_m3 <- glmer(switch ~ contra_satis* hc_dur  +  sexual_satisfaction +  sex_freq + (1| CASEID), family = binomial, data = cccu_SA, control=glmerControl(optimizer="bobyqa"))
summary(sa_m3)

plot(effect(term = "contra_satis* hc_dur", mod = sa_m3, confidence.level = 0.997))

eff = allEffects(mod = sa_m3, confidence.level = 0.997)

#contraceptive satisfaction

eff_hc_dur = eff$`contra_satis:hc_dur`

eff_hc_dur_datplot = data.frame(
  hc_dur = eff_hc_dur$x$hc_dur,
  contra_satis = eff_hc_dur$x$contra_satis,
  estimate = eff_hc_dur$fit,
  lower = eff_hc_dur$lower,
  upper = eff_hc_dur$upper)

nickColors <- function(n, h = c(120,400), l = c(.40,.70), s = c(.8,1), alpha = 3){
  require(colorspace)
  require(scales)
  return (alpha(hex(HLS(seq(h[1],h[2],length.out = n), seq(l[1],l[2],length.out = n), seq(s[1],s[2],length.out=n))), alpha))
}
barplot(rep(1,12), col = nickColors(12))


plot_hc_dur <- ggplot(data = eff_hc_dur_datplot,
                      aes(
                        x = contra_satis,
                        y = estimate,
                        group = hc_dur,
                        color = hc_dur,
                        fill = hc_dur
                      )) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = hc_dur),
              alpha = 0.03) +
  labs(y = "Probability to Switch", color = "Contraceptive Duration", fill = "Contraceptive Duration") +
  scale_x_discrete("Contraceptive Satisfaction",
                   limits = c("1", "2", "3", "4")) +
  scale_fill_gradientn(
    colors = nickColors(12),
    breaks = c(0, 10, 20, 30, 40),
    labels = c("0 Months", "10 Months", "20 Months", "30 Months", "40 Months")
  ) +
  scale_color_gradientn(
    colors = nickColors(12),
    breaks = c(0, 10, 20, 30, 40),
    labels = c("0 Months", "10 Months", "20 Months", "30 Months", "40 Months")
  ) +
  apatheme

plot_hc_dur



plot_hc_dur_separate <- ggplot(data = eff_hc_dur_datplot,
                      aes(
                        x = contra_satis,
                        y = estimate,
                        group = hc_dur,
                        color = hc_dur,
                        fill = hc_dur
                      )) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = hc_dur),
              alpha = 0.07)+
    facet_wrap(~hc_dur, nrow = 1)+
  labs(y = "Probability to Switch", color = "Contraceptive Duration", fill = "Contraceptive Duration") +
  scale_x_discrete("Contraceptive Satisfaction",
                   limits = c("1", "2", "3", "4")) +
  scale_fill_continuous(
    breaks = c(0, 10, 20, 30, 40),
    labels = c("0 Months", "10 Months", "20 Months", "30 Months", "40 Months")
  ) +
  scale_color_continuous(
    breaks = c(0, 10, 20, 30, 40),
    labels = c("0 Months", "10 Months", "20 Months", "30 Months", "40 Months")
  ) +
  apatheme


plot_hc_dur_separate



#join plots
figure <-
  ggarrange(
    plot_contra_satis,
    plot_sexual_satisfaction,
    plot_sex_freq,
    common.legend = TRUE,legend = "right",
    labels = c("A", "B", "C"),
    ncol = 2,
    nrow = 2
  )
figure


#effect of avoidance
#filter for first measurement occasion
length(unique(cccu_MA$CASEID))


cccu_MA_sens = cccu_MA %>%
  group_by(CASEID) %>%
  arrange(WAVE) %>%
  mutate(count = row_number()) %>%
  ungroup()

cccu_MA_sens = cccu_MA_sens %>%
  filter(count == 1)

m4 = glm(
  switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq + hc *
    AGE + hc * DEGREE_recode +
    hc * POVRATE +
    hc * HLTHPROB_recode + hc * MEDPROB_recode +  hc * GAPINS_recode +
    hc * TYPEINS_recode + hc * NKIDS_t1 +  hc * pregnant_between_waves + hc *
    had_baby_between_waves + hc * Avoid_r +
    hc * FEELPG_recode +
    hc * rel_dur_factor,
  family = binomial,
  data = cccu_MA_sens
)


plot(effect(term = "hc * Avoid_r", mod = m4, confidence.level = 0.997))

eff = allEffects(mod = m4, confidence.level = 0.997)




eff_avoid = eff$`hc:Avoid_r`

eff_avoid_datplot = data.frame(
  hc = eff_avoid$x$hc,
  avoid = eff_avoid$x$Avoid_r,
  estimate = eff_avoid$fit,
  lower = eff_avoid$lower,
  upper = eff_avoid$upper)


plot_avoid <- ggplot(data = eff_avoid_datplot,
                        aes(
                          x = avoid,
                          y = estimate,
                          group = hc,
                          color = hc,
                          fill = hc
                        )) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = hc),
              alpha = 0.07) +
  labs(color = "Group",  fill = "Group") +
  scale_fill_manual(
    values = c("red", "blue"),
    name = "Group",
    breaks = c("hc", "non_hc"),
    labels = c(
      "Hormonal Contraceptive Users",
      "Non-Hormonal Contraceptive Users"
    )
  ) +
  scale_colour_manual(
    values = c("red", "blue"),
    name  = "Group",
    breaks = c("hc", "non_hc"),
    labels = c(
      "Hormonal Contraceptive Users",
      "Non-Hormonal Contraceptive Users"
    )
  ) +
  labs(y = "Probability to Switch") +
  scale_x_discrete(
    "Pregnancy Avoidance",
    limits = c("1", "2", "3", "4", "5", "6")
  ) +
  apatheme

plot_avoid

```



## 4. Forest plot main effects
for models m1, m2, m3, m3_lm, and m4_lm

### Models
####m1
```{r}
m1 <- glmer(switch ~ hc + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))

m1_sum = summary(m1)
```

####m1 in robustness analyses
```{r}
####1 Robustness analyses : m1 
R1_ma_1 <- glmer(switch ~ hc + (1| CASEID), family = binomial, data = cccu_R1, control=glmerControl(optimizer="bobyqa"))

R1_m1_sum = summary(R1_ma_1)

####2 Robustness analyses: m1 
R2_ma_1 <- glmer(switch ~ hc + (1| CASEID), family = binomial, data = cccu_R2, control=glmerControl(optimizer="bobyqa"))

R2_m1_sum = summary(R2_ma_1)

#### 3Robustness analyses: m1 
R3_ma_1 <- glmer(switch ~ hc + (1| CASEID), family = binomial, data = cccu_R3, control=glmerControl(optimizer="bobyqa"))

R3_m1_sum = summary(R3_ma_1)

```


####m2
```{r}
m2 <- glmer(switch ~ hc*contra_satis + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))

m2_sum = summary(m2)
```

####m2 in robustness analyses 
```{r}
#r1
R1_ma_2 <- glmer(switch ~ hc*contra_satis + (1| CASEID), family = binomial, data = cccu_R1, control=glmerControl(optimizer="bobyqa"))

R1_m2_sum = summary(R1_ma_2)

#r2
R2_ma_2 <- glmer(switch ~ hc*contra_satis + (1| CASEID), family = binomial, data = cccu_R2, control=glmerControl(optimizer="bobyqa"))

R2_m2_sum = summary(R2_ma_2)


#r3
R3_ma_2 <- glmer(switch ~ hc*contra_satis + (1| CASEID), family = binomial, data = cccu_R3, control=glmerControl(optimizer="bobyqa"))

R3_m2_sum = summary(R3_ma_2)
```

####m3
```{r}
m3 <- glmer(switch ~ hc * contra_satis +  hc * sexual_satisfaction + hc * sex_freq + (1| CASEID), family = binomial, data = cccu_MA, control=glmerControl(optimizer="bobyqa"))
m3_sum = summary(m3)
```

####m3 in robustness analyses 
```{r}
#r1
R1_ma_3 <- glmer(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + (1| CASEID), family = binomial, data = cccu_R1, control=glmerControl(optimizer="bobyqa"))

R1_m3_sum = summary(R1_ma_3)

#r2
R2_ma_3 <- glmer(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + (1| CASEID), family = binomial, data = cccu_R2, control=glmerControl(optimizer="bobyqa"))

R2_m3_sum = summary(R2_ma_3)

#r3
R3_ma_3 <- glmer(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + (1| CASEID), family = binomial, data = cccu_R3, control=glmerControl(optimizer="bobyqa"))

R3_m3_sum = summary(R3_ma_3)
```



####m3_lm
```{r}
#filter for first measurement occasion
length(unique(cccu_MA$CASEID))


cccu_MA_sens = cccu_MA %>%
  group_by(CASEID) %>%
  arrange(WAVE) %>%
  mutate(count = row_number()) %>%
  ungroup()

cccu_MA_sens = cccu_MA_sens %>%
  filter(count == 1)

table(cccu_MA_sens$WAVE)

#repeat model 3 for sensitivity analyses
m3_lm = glm(switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq,
          family = binomial,
          data = cccu_MA_sens)
```

####m3lm in robustness analyses
```{r}

#r1

#filter for first measurement occasion
length(unique(cccu_R1$CASEID))


cccu_R1_sens = cccu_R1 %>%
  group_by(CASEID) %>%
  arrange(WAVE) %>%
  mutate(count = row_number()) %>%
  ungroup()

cccu_R1_sens = cccu_R1_sens %>%
  filter(count == 1)

table(cccu_R1_sens$WAVE)

#repeat model 3 for sensitivity analyses
R1_m3_lm = glm(switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq,
          family = binomial,
          data = cccu_R1_sens)
R1_m3lm_sum = summary(R1_m3_lm)



#R2

#filter for first measurement occasion
length(unique(cccu_R2$CASEID))


cccu_R2_sens = cccu_R2 %>%
  group_by(CASEID) %>%
  arrange(WAVE) %>%
  mutate(count = row_number()) %>%
  ungroup()

cccu_R2_sens = cccu_R2_sens %>%
  filter(count == 1)

table(cccu_R2_sens$WAVE)

#repeat model 3 for sensitivity analyses
R2_m3_lm = glm(switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq,
          family = binomial,
          data = cccu_R2_sens)
R2_m3lm_sum = summary(R2_m3_lm)

#R3

#filter for first measurement occasion
length(unique(cccu_R3$CASEID))


cccu_R3_sens = cccu_R3 %>%
  group_by(CASEID) %>%
  arrange(WAVE) %>%
  mutate(count = row_number()) %>%
  ungroup()

cccu_R3_sens = cccu_R3_sens %>%
  filter(count == 1)

table(cccu_R3_sens$WAVE)

#repeat model 3 for sensitivity analyses
R3_m3_lm = glm(switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq,
          family = binomial,
          data = cccu_R3_sens)
R3_m3lm_sum = summary(R3_m3_lm)


```



####m4_lm
```{r}
m4_lm = glm(switch ~ hc * contra_satis + hc * sexual_satisfaction +  hc * sex_freq + hc *AGE + hc *DEGREE_recode +
              hc *POVRATE +
              hc *HLTHPROB_recode + hc *MEDPROB_recode +  hc *GAPINS_recode +
              hc *TYPEINS_recode + hc *NKIDS_t1 +  hc *pregnant_between_waves + hc *had_baby_between_waves+ hc *Avoid_r +
              hc *FEELPG_recode +
              hc *rel_dur_factor,
            family = binomial,
            data = cccu_MA_sens)
summary(m4_lm)
```

####m4lm in robustness analysis 
```{r}
#r1
R1_m4_lm <- glm(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + hc *AGE + hc *DEGREE_recode + hc *POVRATE + hc *HLTHPROB_recode + hc *MEDPROB_recode +  hc *GAPINS_recode + hc *TYPEINS_recode + hc *NKIDS_t1 +  hc *pregnant_between_waves + hc *had_baby_between_waves+ hc *Avoid_r + hc *FEELPG_recode + hc *rel_dur_factor, family = binomial, data = cccu_R1_sens)

R1_m4lm_sum = summary(R1_m4_lm)

#r2
R2_m4_lm <- glm(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + hc *AGE + hc *DEGREE_recode + hc *POVRATE + hc *HLTHPROB_recode + hc *MEDPROB_recode +  hc *GAPINS_recode + hc *TYPEINS_recode + hc *NKIDS_t1 +  hc *pregnant_between_waves + hc *had_baby_between_waves+ hc *Avoid_r + hc *FEELPG_recode + hc *rel_dur_factor, family = binomial, data = cccu_R2_sens)

R2_m4lm_sum = summary(R2_m4_lm)

#r3
R3_m4_lm <- glm(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + hc *AGE + hc *DEGREE_recode + hc *POVRATE + hc *HLTHPROB_recode + hc *MEDPROB_recode +  hc *GAPINS_recode + hc *TYPEINS_recode + hc *NKIDS_t1 +  hc *pregnant_between_waves + hc *had_baby_between_waves+ hc *Avoid_r + hc *FEELPG_recode + hc *rel_dur_factor, family = binomial, data = cccu_R3_sens)

R3_m4lm_sum = summary(R3_m4_lm)
```


### Effects and CIs
####m1
```{r}
m1_confint = confint(m1, method = "Wald", level = .997) 

rn = rownames(m1_confint)
m1_confint = data.frame(m1_confint)

colnames(m1_confint) = c("lower", "upper")
m1_confint$predictor = rn


m1_forest_plot = data.frame(
  predictor = names(m1_sum$coefficients[,1]),
  estimate = as.numeric(as.character(m1_sum$coefficients[,1])))

m1_forest_plot = left_join(m1_forest_plot, m1_confint, by = "predictor")

m1_forest_plot$group = rep("multilevel_model_1", 2)

```

####m1 in Robustnessanalyses
```{r}
#R1
R1_m1_confint = confint(R1_ma_1, method = "Wald", level = .997) 

rn = rownames(R1_m1_confint)
R1_m1_confint = data.frame(R1_m1_confint)

colnames(R1_m1_confint) = c("lower", "upper")
R1_m1_confint$predictor = rn


R1_m1_forest_plot = data.frame(
  predictor = names(R1_m1_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R1_m1_sum$coefficients[,1])))

R1_m1_forest_plot = left_join(R1_m1_forest_plot, R1_m1_confint, by = "predictor")

R1_m1_forest_plot$group = rep("R1_multilevel_model_1", 2)


#R2
R2_m1_confint = confint(R2_ma_1, method = "Wald", level = .997) 

rn = rownames(R2_m1_confint)
R2_m1_confint = data.frame(R2_m1_confint)

colnames(R2_m1_confint) = c("lower", "upper")
R2_m1_confint$predictor = rn


R2_m1_forest_plot = data.frame(
  predictor = names(R2_m1_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R2_m1_sum$coefficients[,1])))

R2_m1_forest_plot = left_join(R2_m1_forest_plot, R2_m1_confint, by = "predictor")

R2_m1_forest_plot$group = rep("R2_multilevel_model_1", 2)


#R3
R3_m1_confint = confint(R3_ma_1, method = "Wald", level = .997) 

rn = rownames(R3_m1_confint)
R3_m1_confint = data.frame(R3_m1_confint)

colnames(R3_m1_confint) = c("lower", "upper")
R3_m1_confint$predictor = rn


R3_m1_forest_plot = data.frame(
  predictor = names(R3_m1_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R3_m1_sum$coefficients[,1])))

R3_m1_forest_plot = left_join(R3_m1_forest_plot, R3_m1_confint, by = "predictor")

R3_m1_forest_plot$group = rep("R3_multilevel_model_1", 2)


```


####m2
```{r}
m2_confint = confint(m2, method = "Wald", level = .997) 

rn = rownames(m2_confint)
m2_confint = data.frame(m2_confint)

colnames(m2_confint) = c("lower", "upper")
m2_confint$predictor = rn


m2_forest_plot = data.frame(
  predictor = names(m2_sum$coefficients[,1]),
  estimate = as.numeric(as.character(m2_sum$coefficients[,1])))

m2_forest_plot = left_join(m2_forest_plot, m2_confint, by = "predictor")

m2_forest_plot$group = rep("multilevel_model_2", 4)


```


####m2 in robustness analyses
```{r}
#R1
R1_m2_confint = confint(R1_ma_2, method = "Wald", level = .997) 

rn = rownames(R1_m2_confint)
R1_m2_confint = data.frame(R1_m2_confint)

colnames(R1_m2_confint) = c("lower", "upper")
R1_m2_confint$predictor = rn


R1_m2_forest_plot = data.frame(
  predictor = names(R1_m2_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R1_m2_sum$coefficients[,1])))

R1_m2_forest_plot = left_join(R1_m2_forest_plot, R1_m2_confint, by = "predictor")

R1_m2_forest_plot$group = rep("R1_multilevel_model_2", 4)


#R2
R2_m2_confint = confint(R2_ma_2, method = "Wald", level = .997) 

rn = rownames(R2_m2_confint)
R2_m2_confint = data.frame(R2_m2_confint)

colnames(R2_m2_confint) = c("lower", "upper")
R2_m2_confint$predictor = rn


R2_m2_forest_plot = data.frame(
  predictor = names(R2_m2_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R2_m2_sum$coefficients[,1])))

R2_m2_forest_plot = left_join(R2_m2_forest_plot, R2_m2_confint, by = "predictor")

R2_m2_forest_plot$group = rep("R2_multilevel_model_2", 4)


#R3
R3_m2_confint = confint(R3_ma_2, method = "Wald", level = .997) 

rn = rownames(R3_m2_confint)
R3_m2_confint = data.frame(R3_m2_confint)

colnames(R3_m2_confint) = c("lower", "upper")
R3_m2_confint$predictor = rn


R3_m2_forest_plot = data.frame(
  predictor = names(R3_m2_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R3_m2_sum$coefficients[,1])))

R3_m2_forest_plot = left_join(R3_m2_forest_plot, R3_m2_confint, by = "predictor")

R3_m2_forest_plot$group = rep("R3_multilevel_model_2", 4)



```




####m3
```{r}
m3_confint = confint(m3, method = "Wald", level = .997) 

rn = rownames(m3_confint)
m3_confint = data.frame(m3_confint)

colnames(m3_confint) = c("lower", "upper")
m3_confint$predictor = rn


m3_forest_plot = data.frame(
  predictor = names(m3_sum$coefficients[,1]),
  estimate = as.numeric(as.character(m3_sum$coefficients[,1])))

m3_forest_plot = left_join(m3_forest_plot, m3_confint, by = "predictor")

m3_forest_plot$group = rep("multilevel_model_3", 12)

```

####m3 in robustness analyses 

```{r}
#R1
R1_m3_confint = confint(R1_ma_3, method = "Wald", level = .997) 

rn = rownames(R1_m3_confint)
R1_m3_confint = data.frame(R1_m3_confint)

colnames(R1_m3_confint) = c("lower", "upper")
R1_m3_confint$predictor = rn


R1_m3_forest_plot = data.frame(
  predictor = names(R1_m3_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R1_m3_sum$coefficients[,1])))

R1_m3_forest_plot = left_join(R1_m3_forest_plot, R1_m3_confint, by = "predictor")

R1_m3_forest_plot$group = rep("R1_multilevel_model_3", 4)


#R2
R2_m3_confint = confint(R2_ma_3, method = "Wald", level = .997) 

rn = rownames(R2_m3_confint)
R2_m3_confint = data.frame(R2_m3_confint)

colnames(R2_m3_confint) = c("lower", "upper")
R2_m3_confint$predictor = rn


R2_m3_forest_plot = data.frame(
  predictor = names(R2_m3_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R2_m3_sum$coefficients[,1])))

R2_m3_forest_plot = left_join(R2_m3_forest_plot, R2_m3_confint, by = "predictor")

R2_m3_forest_plot$group = rep("R2_multilevel_model_3", 4)


#R3
R3_m3_confint = confint(R3_ma_3, method = "Wald", level = .997) 

rn = rownames(R3_m3_confint)
R3_m3_confint = data.frame(R3_m3_confint)

colnames(R3_m3_confint) = c("lower", "upper")
R3_m3_confint$predictor = rn


R3_m3_forest_plot = data.frame(
  predictor = names(R3_m3_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R3_m3_sum$coefficients[,1])))

R3_m3_forest_plot = left_join(R3_m3_forest_plot, R3_m3_confint, by = "predictor")

R3_m3_forest_plot$group = rep("R3_multilevel_model_3", 4)




```

####m3_lm
```{r}
m3_lm_confint = confint(m3_lm, method = "Wald", level = .997) 

rn = rownames(m3_lm_confint)
m3_lm_confint = data.frame(m3_lm_confint)

colnames(m3_lm_confint) = c("lower", "upper")
m3_lm_confint$predictor = rn


m3_lm_forest_plot = data.frame(
  predictor = names(m3_lm$coefficients),
  estimate = as.numeric(as.character(m3_lm$coefficients)))

m3_lm_forest_plot = left_join(m3_lm_forest_plot, m3_lm_confint, by = "predictor")

m3_lm_forest_plot$group = rep("model_3", 12)
```
####m3_lm in robustnessanalyses 
```{r}
#R1
R1_m3lm_confint = confint(R1_m3_lm, method = "Wald", level = .997) 

rn = rownames(R1_m3lm_confint)
R1_m3lm_confint = data.frame(R1_m3lm_confint)

colnames(R1_m3lm_confint) = c("lower", "upper")
R1_m3lm_confint$predictor = rn


R1_m3lm_forest_plot = data.frame(
  predictor = names(R1_m3lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R1_m3lm_sum$coefficients[,1])))

R1_m3lm_forest_plot = left_join(R1_m3lm_forest_plot, R1_m3lm_confint, by = "predictor")

R1_m3lm_forest_plot$group = rep("R1_linear_model_3", 4)


#R2
R2_m3lm_confint = confint(R2_m3_lm, method = "Wald", level = .997) 

rn = rownames(R2_m3lm_confint)
R2_m3lm_confint = data.frame(R2_m3lm_confint)

colnames(R2_m3lm_confint) = c("lower", "upper")
R2_m3lm_confint$predictor = rn


R2_m3lm_forest_plot = data.frame(
  predictor = names(R2_m3lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R2_m3lm_sum$coefficients[,1])))

R2_m3lm_forest_plot = left_join(R2_m3lm_forest_plot, R2_m3lm_confint, by = "predictor")

R2_m3lm_forest_plot$group = rep("R2_linear_model_3", 4)


#R3
R3_m3lm_confint = confint(R3_m3_lm, method = "Wald", level = .997) 

rn = rownames(R3_m3lm_confint)
R3_m3lm_confint = data.frame(R3_m3lm_confint)

colnames(R3_m3lm_confint) = c("lower", "upper")
R3_m3lm_confint$predictor = rn


R3_m3lm_forest_plot = data.frame(
  predictor = names(R3_m3lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R3_m3lm_sum$coefficients[,1])))

R3_m3lm_forest_plot = left_join(R3_m3lm_forest_plot, R3_m3lm_confint, by = "predictor")

R3_m3lm_forest_plot$group = rep("R3_linear_model_3", 4)



```





####m4
```{r}
m4_lm_confint = confint(m4_lm, parm = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                               "hcnon_hc:contra_satis",
                                               "hcnon_hc:sexual_satisfaction",
                                               "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"),
                        method = "Wald", level = .997) 

rn = rownames(m4_lm_confint)
m4_lm_confint = data.frame(m4_lm_confint)

colnames(m4_lm_confint) = c("lower", "upper")
m4_lm_confint$predictor = rn


m4_lm_forest_plot = data.frame(
  predictor = names(m4_lm$coefficients),
  estimate = as.numeric(as.character(m4_lm$coefficients)))

m4_lm_forest_plot = left_join(m4_lm_forest_plot, m4_lm_confint, by = "predictor")

m4_lm_forest_plot$group = rep("model_4", 12)
```

####m4lm in robustnessanalyses
```{r}
#R1
R1_m4lm_confint = confint(R1_m4_lm, parm = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                               "hcnon_hc:contra_satis",
                                               "hcnon_hc:sexual_satisfaction",
                                               "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"),method = "Wald", level = .997) 

rn = rownames(R1_m4lm_confint)
R1_m4lm_confint = data.frame(R1_m4lm_confint)

colnames(R1_m4lm_confint) = c("lower", "upper")
R1_m4lm_confint$predictor = rn


R1_m4lm_forest_plot = data.frame(
  predictor = names(R1_m4lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R1_m4lm_sum$coefficients[,1])))

R1_m4lm_forest_plot = left_join(R1_m4lm_forest_plot, R1_m4lm_confint, by = "predictor")

R1_m4lm_forest_plot$group = rep("R1_linear_model_4", 71)



#R2
R2_m4lm_confint = confint(R2_m4_lm, parm = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                               "hcnon_hc:contra_satis",
                                               "hcnon_hc:sexual_satisfaction",
                                               "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"),method = "Wald", level = .997) 

rn = rownames(R2_m4lm_confint)
R2_m4lm_confint = data.frame(R2_m4lm_confint)

colnames(R2_m4lm_confint) = c("lower", "upper")
R2_m4lm_confint$predictor = rn


R2_m4lm_forest_plot = data.frame(
  predictor = names(R2_m4lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R2_m4lm_sum$coefficients[,1])))

R2_m4lm_forest_plot = left_join(R2_m4lm_forest_plot, R2_m4lm_confint, by = "predictor")

R2_m4lm_forest_plot$group = rep("R2_linear_model_4", 71)


#R3
R3_m4lm_confint = confint(R3_m4_lm, parm = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                               "hcnon_hc:contra_satis",
                                               "hcnon_hc:sexual_satisfaction",
                                               "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"),method = "Wald", level = .997) 

rn = rownames(R3_m4lm_confint)
R3_m4lm_confint = data.frame(R3_m4lm_confint)

colnames(R3_m4lm_confint) = c("lower", "upper")
R3_m4lm_confint$predictor = rn


R3_m4lm_forest_plot = data.frame(
  predictor = names(R3_m4lm_sum$coefficients[,1]),
  estimate = as.numeric(as.character(R3_m4lm_sum$coefficients[,1])))

R3_m4lm_forest_plot = left_join(R3_m4lm_forest_plot, R3_m4lm_confint, by = "predictor")

R3_m4lm_forest_plot$group = rep("R3_linear_model_4", 71)

```


### Dataframe for plot
```{r}

forest_plot_data = rbind(m1_forest_plot, m2_forest_plot, m3_forest_plot, m3_lm_forest_plot, m4_lm_forest_plot)
forest_plot_data$predictor = factor(forest_plot_data$predictor,
                                    levels = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                               "hcnon_hc:contra_satis",
                                               "hcnon_hc:sexual_satisfaction",
                                               "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"),
                                    labels = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                               "hcnon_hc:contra_satis",
                                               "hcnon_hc:sexual_satisfaction",
                                               "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"))

forest_plot_data$group = factor(
  forest_plot_data$group,
  levels = c(
    "multilevel_model_1",
    "multilevel_model_2",
    "multilevel_model_3",
    "model_3",
    "model_4"
  ),
  labels = c(
    "multilevel_model_1",
    "multilevel_model_2",
    "multilevel_model_3",
    "model_3",
    "model_4"
  )
)




#for robustness analyses
forest_plot_data2 = rbind(
  m1_forest_plot,
  R1_m1_forest_plot,
  R2_m1_forest_plot,
  R3_m1_forest_plot,
  R1_m2_forest_plot,
  R2_m2_forest_plot,
  R3_m2_forest_plot,
  m2_forest_plot,
  m3_forest_plot,
  R1_m3_forest_plot,
  R2_m3_forest_plot,
  R3_m3_forest_plot,
  m3_lm_forest_plot,
  R1_m3lm_forest_plot,
  R2_m3lm_forest_plot,
  R3_m3lm_forest_plot,
  m4_lm_forest_plot,
  R1_m4lm_forest_plot,
  R2_m4lm_forest_plot,
  R3_m4lm_forest_plot
)
forest_plot_data2$predictor = factor(forest_plot_data2$predictor,
                                    levels = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                               "hcnon_hc:contra_satis",
                                               "hcnon_hc:sexual_satisfaction",
                                               "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"),
                                    labels = c("(Intercept)",
                                               "hcnon_hc",
                                               "contra_satis",
                                               "sexual_satisfaction",
                                               "sex_freq2-5 times", "sex_freq6-10 times",
                                               "sex_freq11 or more times", 
                                               "hcnon_hc:contra_satis",
                                               "hcnon_hc:sexual_satisfaction",
                                               "hcnon_hc:sex_freq2-5 times",
                                               "hcnon_hc:sex_freq6-10 times",
                                               "hcnon_hc:sex_freq11 or more times"))

forest_plot_data2$group = factor(
  forest_plot_data2$group,
  levels = c(
    "multilevel_model_1",
    "R1_multilevel_model_1",
    "R2_multilevel_model_1",
    "R3_multilevel_model_1",
    "multilevel_model_2",
    "R1_multilevel_model_2",
    "R2_multilevel_model_2",
    "R3_multilevel_model_2",
    "multilevel_model_3",
    "R1_multilevel_model_3",
    "R2_multilevel_model_3",
    "R3_multilevel_model_3",
    "model_3",
    "R1_linear_model_3",
    "R2_linear_model_3",
    "R3_linear_model_3",
    "model_4",
    "R1_linear_model_4",
    "R2_linear_model_4",
    "R3_linear_model_4"
  ),
  labels = c(
    "multilevel_model_1",
    "R1_multilevel_model_1",
    "R2_multilevel_model_1",
    "R3_multilevel_model_1",
    "multilevel_model_2",
    "R1_multilevel_model_2",
    "R2_multilevel_model_2",
    "R3_multilevel_model_2",
    "multilevel_model_3",
    "R1_multilevel_model_3",
    "R2_multilevel_model_3",
    "R3_multilevel_model_3",
    "model_3",
    "R1_linear_model_3",
    "R2_linear_model_3",
    "R3_linear_model_3",
    "model_4",
    "R1_linear_model_4",
    "R2_linear_model_4",
    "R3_linear_model_4"
  )
)

```

### Plot
```{r}
forest_main <- ggplot(
  data = forest_plot_data %>%
    filter(predictor != "(Intercept)"),
  aes(
    x = predictor,
    y = estimate,
    group = group,
    fill = group,
    color = group
  )
) +
  geom_point(position = position_dodge(width = -0.3)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width =
                                                                               -0.3)) +
  scale_x_discrete(limits = rev) +
  geom_hline(yintercept = 0) +
  coord_flip() +
  scale_fill_discrete(
    name = "Model",
    breaks = c(
      "multilevel_model_1",
      "multilevel_model_2",
      "multilevel_model_3",
      "model_3",
      "model_4"
    ),
    labels = c(
      "multilevel model 1",
      "multilevel model 2",
      "multilevel model 3",
      "model 3",
      "model 4"
    ),
  ) +
  scale_colour_discrete(
    name  = "Model",
    breaks = c(
      "multilevel_model_1",
      "multilevel_model_2",
      "multilevel_model_3",
      "model_3",
      "model_4"
    ),
    labels = c(
      "multilevel model 1",
      "multilevel model 2",
      "multilevel model 3",
      "model 3",
      "model 4"
    )
  ) +
  labs(y = "Probability to Switch", x = "Predictor") +
  
  apatheme

forest_main


#forest plot including robustness analyses
forest_ma_ra <- ggplot(
  data = forest_plot_data2 %>%
    filter(predictor != "(Intercept)"),
  aes(
    x = predictor,
    y = estimate,
    group = group,
    fill = group,
    color = group
  )
) +
  geom_point(position = position_dodge(width = -0.3)) +
  geom_pointrange(aes(ymin = lower, ymax = upper), position = position_dodge(width =
                                                                               -0.3)) +
  scale_x_discrete(limits = rev) +
  geom_hline(yintercept = 0) +
  coord_flip() +
  scale_fill_discrete(
    name = "Model",
    breaks = c(
      "multilevel_model_1",
      "R1_multilevel_model_1",
      "R2_multilevel_model_1",
      "R3_multilevel_model_1",
      "multilevel_model_2",
      "R1_multilevel_model_2",
      "R2_multilevel_model_2",
      "R3_multilevel_model_2",
      "multilevel_model_3",
      "R1_multilevel_model_3",
      "R2_multilevel_model_3",
      "R3_multilevel_model_3",
      "model_3",
      "R1_linear_model_3",
      "R2_linear_model_3",
      "R3_linear_model_3",
      "model_4",
      "R1_linear_model_4",
      "R2_linear_model_4",
      "R3_linear_model_4"
    ),
    labels = c(
      "multilevel model 1",
      "R1 multilevel model 1",
      "R2 multilevel model 1",
      "R3 multilevel model 1",
      "multilevel model 2",
      "R1 multilevel model 2",
      "R2 multilevel model 2",
      "R3 multilevel model 2",
      "multilevel model 3",
      "R1 multilevel model 3",
      "R2 multilevel model 3",
      "R3 multilevel model 3",
      "model 3",
      "R1 linear model 3",
      "R2 linear model 3",
      "R3 linear model 3",
      "model 4",
      "R1 linear model 4",
      "R2 linear model 4",
      "R3 linear model 4"
    )
  ) +
  scale_colour_discrete(
    name  = "Model",
    breaks = c(
      "multilevel_model_1",
      "R1_multilevel_model_1",
      "R2_multilevel_model_1",
      "R3_multilevel_model_1",
      "multilevel_model_2",
      "R1_multilevel_model_2",
      "R2_multilevel_model_2",
      "R3_multilevel_model_2",
      "multilevel_model_3",
      "R1_multilevel_model_3",
      "R2_multilevel_model_3",
      "R3_multilevel_model_3",
      "model_3",
      "R1_linear_model_3",
      "R2_linear_model_3",
      "R3_linear_model_3",
      "model_4",
      "R1_linear_model_4",
      "R2_linear_model_4",
      "R3_linear_model_4"
    ),
    labels = c(
      "multilevel model 1",
      "R1 multilevel model 1",
      "R2 multilevel model 1",
      "R3 multilevel model 1",
      "multilevel model 2",
      "R1 multilevel model 2",
      "R2 multilevel model 2",
      "R3 multilevel model 2",
      "multilevel model 3",
      "R1 multilevel model 3",
      "R2 multilevel model 3",
      "R3 multilevel model 3",
      "model 3",
      "R1 linear model 3",
      "R2 linear model 3",
      "R3 linear model 3",
      "model 4",
      "R1 linear model 4",
      "R2 linear model 4",
      "R3 linear model 4"
    )
  ) +
  labs(y = "Probability to Switch", x = "Predictor") +
  
  apatheme

forest_ma_ra


```


