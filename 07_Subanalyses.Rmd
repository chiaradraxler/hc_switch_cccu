---
title: "07_Subanalyses"
author: "Chiara Draxler"
date: "24 1 2022"
output: html_document
---

##Introduction for working code:

0. Select a folder specific for the R project and define to use the folder for the R project constantly (when downloading the code from GitHub the folder will be hc_switch_cccu-main)

1. Download data from 
https://www.icpsr.umich.edu/web/DSDR/studies/37067/datadocumentation

--> Click on Download, then select R, then follow the login
--> store data in the folder specific to the R project in an extra sub-folder called RData (i.e., hc_switch_cccu-main - > RData)

--> Within the RData folder store data for wave 1 in DS0001, for wave 2 in DS0002 and so on  (i.e., hc_switch_cccu-main - > RData -> DS0001 )

--> name the Rdata files according to the wave: 

Wave 1: 37067-0001-Data (i.e., hc_switch_cccu-main - > RData -> DS0001 -> 37067-0001-Data.rda )

Wave 2: 37067-0002-Data (i.e., hc_switch_cccu-main - > RData -> DS0002 -> 37067-0002-Data.rda )


Wave 3: 37067-0003-Data (i.e., hc_switch_cccu-main - > RData -> DS0003 -> 37067-0003-Data.rda )


Wave 4: 37067-0004-Data (i.e., hc_switch_cccu-main - > RData -> DS0004 -> 37067-0004-Data.rda )


--> attention to the .rda ending when loading the data into R!

2. make sure to install all relevant packages before running the code!

All relevant packages and versions can be seen in the section "Analyses"

3. run the code according to the defined order beginning with 01_ (or 0 if you want to have a look at the synthetic data) and ending with 09_ so that all data frames are created appropriately

4. Run  the Code :) 

#1. Load Data
```{r}

load("cccu_SA.RData")
length(unique(cccu_SA$CASEID)) #women
```


#2. Load Packages
```{r}
library(lme4)
library(marginaleffects)
library(formr)
library(effects)
library(EValue)
library(psych)
library(dplyr)
library(tidyverse)
options(scipen=999)
```


#3. Models


##3.2 Model 2: including directly with contraceptive method associated predictors

DURATION and satisfaction!

```{r}
sa_m2 <- glmer(switch ~ contra_satis * hc_dur + (1| CASEID), family = binomial, data = cccu_SA, control=glmerControl(optimizer="bobyqa"))

summary(sa_m2)
confint(sa_m2, method = "Wald", level = .997)
plot(allEffects(sa_m2))
```


##3.3 Model 3: including not directly with contraceptive method associated predictors
```{r}
sa_m3 <- glmer(switch ~ contra_satis* hc_dur  +  sexual_satisfaction +  sex_freq + (1| CASEID), family = binomial, data = cccu_SA, control=glmerControl(optimizer="bobyqa"))

summary(sa_m3)
confint(sa_m3, method = "Wald", level = .997)
plot(allEffects(sa_m3))
```

##3.4 Model 4: Controlling for observed selection effects
```{r}
#filter for first measurement occasion
length(unique(cccu_SA$CASEID))


cccu_SA_sens = cccu_SA %>%
  group_by(CASEID) %>%
  arrange(WAVE) %>%
  mutate(count = row_number()) %>%
  ungroup()

cccu_SA_sens = cccu_SA_sens %>%
  filter(count == 1)

table(cccu_SA_sens$WAVE)


#repeating model 3 as linear model 
sa_m3_lm <- glm(switch ~ contra_satis* hc_dur  +  sexual_satisfaction +  sex_freq, family = binomial, data = cccu_SA_sens)

summary(sa_m3_lm)
confint(sa_m3_lm, method = "Wald", level = .997)
plot(allEffects(sa_m3_lm))

#model 4 as linear model (did not converge otherwise)

sa_m4_lm <- glm(switch ~ contra_satis*hc_dur +  sexual_satisfaction +   sex_freq + AGE + DEGREE_recode + POVRATE + HLTHPROB_recode + MEDPROB_recode + GAPINS_recode +
              TYPEINS_recode + NKIDS_t1 +  pregnant_between_waves + had_baby_between_waves+ Avoid_r + FEELPG_recode +
              rel_dur_factor,
            family = binomial,
            data = cccu_SA_sens)

summary(sa_m4_lm)
confint(sa_m4_lm, method = "Wald", level = .997)
plot(allEffects(sa_m4_lm))
```


###Average marginal effects
####m2
```{r}
#average marginal effect
ame <- marginaleffects(sa_m2)
summary(ame)
```

####m3
```{r}
#average marginal effect
ame <- marginaleffects(sa_m3)
summary(ame)
```

####m4
```{r}
#average marginal effect

ame <- marginaleffects(sa_m3_lm)
summary(ame)
ame <- marginaleffects(sa_m4_lm)
summary(ame)

```


