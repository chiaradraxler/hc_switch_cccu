---
title: "11_SubAnalysis_Models"
author: "Chiara Draxler & Laura Botzet"
date: "16 11 2022"
output: html_document
---
# 1. Load Packages
```{r}
library(brms)
library(marginaleffects)
library(tidyverse)


options(scipen = 999)

set.seed(180822)

set_priors <- c(prior(normal(0, 1), class = b),
                prior(normal(0, 1), class = sd))
```

# 2. Load Data
```{r}
load("cccu_MA.RData")

cccu_MA <- cccu_MA %>%
  arrange(CASEID) %>%
  mutate_if(is.factor, droplevels)
```

# Datawrangling
```{r}
cccu_MA <- cccu_MA %>%
  mutate(
    hc_dur = ifelse(hc == "non_hc", -9999, hc_dur),
    hc_dummy = ifelse(hc == "non_hc", 0,
                      ifelse(hc == "hc", 1, NA))
  )
```

# Inspect data
```{r}
class(cccu_MA$hc)
levels(cccu_MA$hc)

library(formr)
crosstabs( ~ hc + hc_dur, data = cccu_MA)

class(cccu_MA$hc_dummy)
table(cccu_MA$hc_dummy)
crosstabs( ~ hc_dummy + hc_dur, data = cccu_MA)
```

# Frequentist models
```{r}
library(lme4)
sa_m1_freq <- glmer(switch ~ hc + hc:hc_dur + (1 | CASEID),
                    family = binomial(link = "logit"),
                    data = cccu_MA)

summary(sa_m1_freq)

sa_m1_freq_dummy <- glmer(
  switch ~ hc_dummy + hc_dummy:hc_dur + (1 | CASEID),
  family = binomial(link = "logit"),
  data = cccu_MA
)

summary(sa_m1_freq)
```

# 3. Models

## 3.1 Model 1: including directly with contraceptive method associated predictors

DURATION and satisfaction!

```{r}
sa_m1 <- brm(
  switch ~ hc_dummy + hc_dummy:hc_dur + (1 | CASEID),
  family = bernoulli(),
  data = cccu_MA,
  prior = set_priors,
  file = "models/sa_m1_1.Rds"
)

summary(sa_m1, prob = .997)
```

## 3.2 Model 2: including directly with contraceptive method associated predictors

DURATION and satisfaction!

```{r}
sa_m2 <- brm(
  switch ~ hc_dummy * contra_satis + hc_dummy:hc_dur + hc_dummy:hc_dur:contra_satis +
    (1 | CASEID),
  family = bernoulli(),
  data = cccu_MA,
  prior = set_priors,
  file = "models/sa_m2_1.Rds"
)

summary(sa_m2, prob = .997)
```


## 3.3 Model 3: including sexual satisfaction & sexual frequency
```{r}
sa_m3 <-
  brm(
    switch ~ hc_dummy * contra_satis +  hc_dummy * sexual_satisfaction +
      hc_dummy * sex_freq + hc_dummy:hc_dur +
      hc_dummy:hc_dur:contra_satis +
      hc_dummy:hc_dur:sexual_satisfaction +
      hc_dummy:hc_dur:sex_freq +
      (1 | CASEID),
    family = bernoulli(),
    data = cccu_MA,
    prior = set_priors,
    file = "models/sa_m3_1.Rds"
  )

summary(sa_m3, prob = .997)
```

## 3.4 Model 4: Controlling for observed selection effects
```{r}
sa_m4 <-
  brm(
    switch ~ hc_dummy * contra_satis +  hc_dummy * sexual_satisfaction + 
      hc_dummy * sex_freq +
      hc_dummy * AGE + hc_dummy * DEGREE_recode +
      hc_dummy * POVRATE +
      hc_dummy * HLTHPROB_recode + hc_dummy * MEDPROB_recode +  hc_dummy * GAPINS_recode +
      hc_dummy * TYPEINS_recode + hc_dummy * NKIDS_t1 +  hc_dummy * pregnant_between_waves +
      hc_dummy * had_baby_between_waves + hc_dummy * Avoid_r +
      hc_dummy * FEELPG_recode +
      hc_dummy * rel_dur_factor +
      hc_dummy:hc_dur +
      hc_dummy:hc_dur:contra_satis +
      hc_dummy:hc_dur:sexual_satisfaction +
      hc_dummy:hc_dur:sex_freq +
      hc_dummy:hc_dur:AGE +
      hc_dummy:hc_dur:DEGREE_recode +
      hc_dummy:hc_dur:POVRATE +
      hc_dummy:hc_dur:HLTHPROB_recode +
      hc_dummy:hc_dur:MEDPROB_recode +
      hc_dummy:hc_dur:GAPINS_recode +
      hc_dummy:hc_dur:TYPEINS_recode +
      hc_dummy:hc_dur:NKIDS_t1 +
      hc_dummy:hc_dur:pregnant_between_waves +
      hc_dummy:hc_dur:had_baby_between_waves +
      hc_dummy:hc_dur:Avoid_r +
      hc_dummy:hc_dur:FEELPG_recode +
      hc_dummy:hc_dur:rel_dur_factor +
      (1 | CASEID),
    family = bernoulli(),
    data = cccu_MA,
    prior = set_priors,
    file = "models/sa_m4_1.Rds"
  )

summary(sa_m4, prob = .997)
```


