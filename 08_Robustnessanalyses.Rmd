---
title: "08_Robustnessanalysis"
author: "Chiara Draxler"
date: "24 1 2022"
output: html_document
---
#1. Load Data
```{r}
#MA
load("cccu_R1.RData")
load("cccu_R2.RData")
load("cccu_R3.RData")

#SA
load("cccu_R1_s.RData")
load("cccu_R2_s.RData")
load("cccu_R3_s.RData")
```


#2. Load Packages
```{r}
library(lme4)
library(effects)
```

#3. R1:Analysis of Robustness 1

##Main Analysis

###3.1 Model 1: basic model
```{r}
R1_ma_1 <- glmer(switch ~ hc + (1| CASEID), family = binomial, data = cccu_R1, control=glmerControl(optimizer="bobyqa"))

summary(R1_ma_1)
confint(R1_ma_1, method = "Wald", level = .997)
plot(allEffects(R1_ma_1))

```


###3.2 Model 2: including directly with contraceptive method associated predictors
```{r}
R1_ma_2 <- glmer(switch ~ hc*contra_satis + (1| CASEID), family = binomial, data = cccu_R1, control=glmerControl(optimizer="bobyqa"))

summary(R1_ma_2)
confint(R1_ma_2, method = "Wald", level = .997)
plot(allEffects(R1_ma_2))
```

###3.3 Model 3: including not directly with contraceptive method associated predictors
```{r}
R1_ma_3 <- glmer(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + (1| CASEID), family = binomial, data = cccu_R1, control=glmerControl(optimizer="bobyqa"))

summary(R1_ma_3)
confint(R1_ma_3, method = "Wald", level = .997)
plot(allEffects(R1_ma_3))

```

###3.4 Model 4: Controlling for observed selection effects
```{r}
R1_ma_4 <- glm(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + hc *AGE + hc *DEGREE_recode + hc *POVRATE + hc *HLTHPROB_recode + hc *MEDPROB_recode +  hc *GAPINS_recode + hc *TYPEINS_recode + hc *NKIDS_t1 +  hc *pregnant_between_waves + hc *had_baby_between_waves+ hc *Avoid_r + hc *FEELPG_recode + hc *rel_dur_factor, family = binomial, data = cccu_R1)

summary(R1_ma_4)
confint(R1_ma_4, method = "Wald", level = .997)
plot(allEffects(R1_ma_4))
```

###R1: Average marginal effects
####m1
```{r}

#add predicted values
data_pred<-predictions(R1_ma_1) |> head()
#contrasts
cmp <- comparisons(R1_ma_1)
#average marginal effect
summary(cmp)
ame <- marginaleffects(R1_ma_1)
summary(ame)


```

####m2
```{r}
#add predicted values
predictions(R1_ma_2) |> head()
#contrasts
cmp <- comparisons(R1_ma_2)
#average marginal effect
summary(cmp)
ame <- marginaleffects(R1_ma_2)
summary(ame)
```

####m3
```{r}
#add predicted values
predictions(R1_ma_3) |> head()
#contrasts
cmp <- comparisons(R1_ma_2)
#average marginal effect
summary(cmp)
ame <- marginaleffects(R1_ma_2)
summary(ame)
```

####m4
```{r}
#add predicted values
predictions(R1_ma_2) |> head()
#contrasts
cmp <- comparisons(R1_ma_2)
#average marginal effect
summary(cmp)
ame <- marginaleffects(R1_ma_2, interactions)
summary(ame)

```




## R1: Sub Analysis

###3.2 Model 2: including directly with contraceptive method associated predictors

DURATION and satisfaction!

```{r}
R1_sa_m2 <- glmer(switch ~ contra_satis * hc_dur + (1| CASEID), family = binomial, data = cccu_R1_s, control=glmerControl(optimizer="bobyqa"))

summary(R1_sa_m2)
confint(R1_sa_m2, method = "Wald", level = .997)
plot(allEffects(R1_sa_m2))
```
###R1_SA: Average marginal effects
####sa_m2
```{r}
#average marginal effect
ame <- marginaleffects(R1_sa_m2)
summary(ame)
```


#4. R2:Analysis of Robustness 2

##Main Analysis

###4.1 Model 1: basic model
```{r}
R2_ma_1 <- glmer(switch ~ hc + (1| CASEID), family = binomial, data = cccu_R2, control=glmerControl(optimizer="bobyqa"))

summary(R2_ma_1)
confint(R2_ma_1, method = "Wald", level = .997)
plot(allEffects(R2_ma_1))

```


###4.2 Model 2: including directly with contraceptive method associated predictors
```{r}
R2_ma_2 <- glmer(switch ~ hc*contra_satis + (1| CASEID), family = binomial, data = cccu_R2, control=glmerControl(optimizer="bobyqa"))

summary(R2_ma_2)
confint(R2_ma_2, method = "Wald", level = .997)
plot(allEffects(R2_ma_2))
```

###4.3 Model 3: including not directly with contraceptive method associated predictors
```{r}
R2_ma_3 <- glmer(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + (1| CASEID), family = binomial, data = cccu_R2, control=glmerControl(optimizer="bobyqa"))

summary(R2_ma_3)
confint(R2_ma_3, method = "Wald", level = .997)
plot(allEffects(R2_ma_3))

```

###4.4 Model 4: Controlling for observed selection effects
```{r}
R2_ma_4 <- glm(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + hc *AGE + hc *DEGREE_recode + hc *POVRATE + hc *HLTHPROB_recode + hc *MEDPROB_recode +  hc *GAPINS_recode + hc *TYPEINS_recode + hc *NKIDS_t1 +  hc *pregnant_between_waves + hc *had_baby_between_waves+ hc *Avoid_r + hc *FEELPG_recode + hc *rel_dur_factor, family = binomial, data = cccu_R2)

summary(R2_ma_4)
confint(R2_ma_4, method = "Wald", level = .997)
plot(allEffects(R2_ma_4))
```

###R2: Average marginal effects
####m1
```{r}

#add predicted values
data_pred<-predictions(R2_ma_1) |> head()
#contrasts
cmp <- comparisons(R2_ma_1)
#average marginal effect
summary(cmp)
ame <- marginaleffects(R2_ma_1)
summary(ame)


```

####m2
```{r}
#add predicted values
predictions(R2_ma_2) |> head()
#contrasts
cmp <- comparisons(R2_ma_2)
#average marginal effect
summary(cmp)
ame <- marginaleffects(R2_ma_2)
summary(ame)
```

####m3
```{r}
#add predicted values
predictions(R2_ma_3) |> head()
#contrasts
cmp <- comparisons(R2_ma_2)
#average marginal effect
summary(cmp)
ame <- marginaleffects(R2_ma_2)
summary(ame)
```

####m4
```{r}
#add predicted values
predictions(R2_ma_2) |> head()
#contrasts
cmp <- comparisons(R2_ma_2)
#average marginal effect
summary(cmp)
ame <- marginaleffects(R2_ma_2, interactions)
summary(ame)

```



## Sub Analysis

###4.2 Model 2: including directly with contraceptive method associated predictors

DURATION and satisfaction!

```{r}
R2_sa_m2 <- glmer(switch ~ contra_satis * hc_dur + (1| CASEID), family = binomial, data = cccu_R2_s, control=glmerControl(optimizer="bobyqa"))

summary(R2_sa_m2)
confint(R2_sa_m2, method = "Wald", level = .997)
plot(allEffects(R2_sa_m2))
```


###R2_SA: Average marginal effects
####sa_m2
```{r}
#average marginal effect
ame <- marginaleffects(R2_sa_m2)
summary(ame)
```



#5. Analysis of Robustness R3

##Main Analysis

###5.1 Model 1: basic model
```{r}
R3_ma_1 <- glmer(switch ~ hc + (1| CASEID), family = binomial, data = cccu_R3, control=glmerControl(optimizer="bobyqa"))

summary(R3_ma_1)
confint(R3_ma_1, method = "Wald", level = .997)
plot(allEffects(R3_ma_1))

```


###5.2 Model 2: including directly with contraceptive method associated predictors
```{r}
R3_ma_2 <- glmer(switch ~ hc*contra_satis + (1| CASEID), family = binomial, data = cccu_R3, control=glmerControl(optimizer="bobyqa"))

summary(R3_ma_2)
confint(R3_ma_2, method = "Wald", level = .997)
plot(allEffects(R3_ma_2))
```

###5.3 Model 3: including not directly with contraceptive method associated predictors
```{r}
R3_ma_3 <- glmer(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + (1| CASEID), family = binomial, data = cccu_R3, control=glmerControl(optimizer="bobyqa"))

summary(R3_ma_3)
confint(R3_ma_3, method = "Wald", level = .997)
plot(allEffects(R3_ma_3))

```

###5.4 Model 4: Controlling for observed selection effects
```{r}
R3_ma_4 <- glm(switch ~ hc * contra_satis + hc * sexual_satisfaction + hc * sex_freq + hc *AGE + hc *DEGREE_recode + hc *POVRATE + hc *HLTHPROB_recode + hc *MEDPROB_recode +  hc *GAPINS_recode + hc *TYPEINS_recode + hc *NKIDS_t1 +  hc *pregnant_between_waves + hc *had_baby_between_waves+ hc *Avoid_r + hc *FEELPG_recode + hc *rel_dur_factor, family = binomial, data = cccu_R3)

summary(R3_ma_4)
confint(R3_ma_4, method = "Wald", level = .997)
plot(allEffects(R3_ma_4))
```

###R3: Average marginal effects
####m1
```{r}

#add predicted values
data_pred<-predictions(R3_ma_1) |> head()
#contrasts
cmp <- comparisons(R3_ma_1)
#average marginal effect
summary(cmp)
ame <- marginaleffects(R3_ma_1)
summary(ame)


```

####m2
```{r}
#add predicted values
predictions(R3_ma_2) |> head()
#contrasts
cmp <- comparisons(R3_ma_2)
#average marginal effect
summary(cmp)
ame <- marginaleffects(R3_ma_2)
summary(ame)
```

####m3
```{r}
#add predicted values
predictions(R3_ma_3) |> head()
#contrasts
cmp <- comparisons(R3_ma_2)
#average marginal effect
summary(cmp)
ame <- marginaleffects(R3_ma_2)
summary(ame)
```

####m4
```{r}
#add predicted values
predictions(R3_ma_2) |> head()
#contrasts
cmp <- comparisons(R3_ma_2)
#average marginal effect
summary(cmp)
ame <- marginaleffects(R3_ma_2, interactions)
summary(ame)

```




## Sub Analysis

##5.2 Model 2: including directly with contraceptive method associated predictors

DURATION and satisfaction!

```{r}
R3_sa_m2 <- glmer(switch ~ contra_satis * hc_dur + (1| CASEID), family = binomial, data = cccu_R3_s, control=glmerControl(optimizer="bobyqa"))

summary(R3_sa_m2)
confint(R3_sa_m2, method = "Wald", level = .997)
plot(allEffects(R3_sa_m2))

```


###R3_SA: Average marginal effects
####sa_m2
```{r}
#average marginal effect
ame <- marginaleffects(R3_sa_m2)
summary(ame)
```
