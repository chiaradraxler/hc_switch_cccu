---
title: "03_Exclusion"
author: "Chiara Draxler"
date: "21 1 2022"
output: html_document
---


#1. Load Data
```{r}

load("Fake_cccu_complete1.RData")
```

#2. Load Packages

```{r}
library(dplyr)
```

#3. Full Dataset
```{r}
nrow(Fake_cccu_complete1) #timepoints
length(unique(Fake_cccu_complete1$CASEID)) #women

```

##3.1 Exclude t4 from df (bc. not necessary)


# 4 Building columns that indicate exclusion from df
1 = yes 

## 4.1 Missing Main Predictor: HC
Dont exclude current IUD & non-hormonal

```{r}
table(Fake_cccu_complete1$hc)
table(is.na(Fake_cccu_complete1$hc))

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_missing_predHC = ifelse(is.na(hc), 1, 0))
```

## 4.2 Missing Main Predictor: Satisfaction with HC
```{r}
table(Fake_cccu_complete1$contra_satisfaction)
table(is.na(Fake_cccu_complete1$contra_satisfaction))

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_missing_pred_contra_satis = ifelse(is.na(contra_satisfaction), 1, 0))
```


## 4.3 Missing Main Predictor: Sex Freq & Sex Sat

```{r}
#sex freq
table(Fake_cccu_complete1$sex_freq)
table(is.na(Fake_cccu_complete1$sex_freq))

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_missing_pred_sex_freq= ifelse(is.na(sex_freq), 1, 0))

#sex_sat
table(Fake_cccu_complete1$sexual_satisfaction)
table(is.na(Fake_cccu_complete1$sexual_satisfaction))

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_missing_pred_sex_sat= ifelse(is.na(sexual_satisfaction), 1, 0))


```

## 4.4 Missing Selection Predictors
```{r}
Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate( exclusion_missing_selection = ifelse(is.na(AGE) | is.na(DEGREE_recode) | is.na(POVRATE)| is.na(HLTHPROB_recode) | is.na(MEDPROB_recode)| is.na(GAPINS_recode) | is.na(TYPEINS_recode) | is.na(NKIDS_t1) |is.na(pregnant_between_waves) | is.na(had_baby_between_waves) | is.na(FEELPG_recode) | is.na(Avoid_recode) | is.na(rel_dur_factor), 1, 0))

```


## 4.5 Missing Outcome (switch)
Dont exclude next IUD & non-hormonal
```{r}
table(Fake_cccu_complete1$switch)
table(is.na(Fake_cccu_complete1$switch))

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_missing_outc_switch= ifelse(is.na(switch), 1, 0))

```


## 4.6 Emergency contraception
```{r}
#overview

table(Fake_cccu_complete1$EC_recode)

#create column that indicates if used EC

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
  mutate(exclusion_used_EC = ifelse(is.na(EC_recode), 0,
                                    ifelse(EC_recode == "No", 0,
                                           ifelse(EC_recode == "Yes", 1, NA))))

```

## 4.7 IUD & Non-Hormonal
```{r}
#IUD & non-hormonal 
Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_IUD = ifelse(is.na(IUD) & hc == "0", 1,0))

table(is.na(Fake_cccu_complete2$IUD))
table(Fake_cccu_complete2$exclusion_IUD)

crosstabs(~exclusion_IUD + hc + IUD, data = Fake_cccu_complete1)

#IUD_next & non-hormonal 
Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_IUD_next = ifelse(is.na(IUD_next) & hc == "0", 1,0))

table(is.na(Fake_cccu_complete2$IUD_next))
table(Fake_cccu_complete2$exclusion_IUD_next)

crosstabs(~exclusion_IUD_next + hc + IUD_next, data = Fake_cccu_complete1)

```


## 4.8 Subanalyses Duration
### 4.8.1 non-hormonal contra
```{r}
table(Fake_cccu_complete1$hc)

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_missing_used_non_hc= ifelse(hc == "0", 1, 0))

```

### 4.8.2 unknow duration
```{r}
table(Fake_cccu_complete1$contra_dura)
table(is.na(Fake_cccu_complete1$contra_dura))

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_missing_pred_contra_dura= ifelse(is.na(contra_dura), 1, 0))

```


## 4.9 Robustness analyses
### 4.9.1. No sex + no contra
```{r}
table(Fake_cccu_complete1$NOBARRIER)#no non-hormonal contraceptive method in last 30days
table(Fake_cccu_complete1$hc)#no hormonal contracepive method 
#joint = no contraceptive method 

table(Fake_cccu_complete1$sex_inlast30days)#no sex in last 30 days

#create column that indicates with 1 = no sex and no contraceptive method used in last 30 days

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
  mutate(exclusion_R1 = ifelse(NOBARRIER == "(1) Yes" & 
                                 hc == "non_hc" &
                                 sex_inlast30days == "No",1,0))

table(Fake_cccu_complete1$exclusion_R1)

crosstabs(~exclusion_R1 + hc + NOBARRIER + sex_inlast30days, data = Fake_cccu_complete1) #seems to have worked :) :) (see NOBARRIER = (1) Yes, sex_inlast30days = No)

```

### 4.9.2. Sex + no contra

```{r}
#overview over relevant variables

table(Fake_cccu_complete1$NOBARRIER)#no non-hormonal contraceptive method in last 30days
table(Fake_cccu_complete1$hc)#no hormonal contracepive method 
#joint = no contraceptive method 

table(Fake_cccu_complete1$sex_inlast30days)# yes= sex in last 30 days

#create column that indicates with 1 = sex and no contraceptive method used in last 30 days

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
  mutate(exclusion_R2 = ifelse(NOBARRIER == "(1) Yes" & 
                                 hc == "non_hc" &
                                 sex_inlast30days == "Yes",1,0))

table(Fake_cccu_complete1$exclusion_R2)

crosstabs(~exclusion_R1 + hc + NOBARRIER + sex_inlast30days, data = Fake_cccu_complete1) #seems to have worked :) :) (see NOBARRIER = (1) Yes, sex_inlast30days = Yes)

```

### 4.9.3. Vasectomy
```{r}
#overview

table(Fake_cccu_complete1$VASECTOMY)
table(Fake_cccu_complete1$SP1VAS)
table(Fake_cccu_complete1$SP2VAS)
crosstabs(~exclusion_R3+SP2VAS, data = Fake_cccu_complete1)


#create column that indicates if used Vasectomy

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
  mutate(exclusion_R3 = ifelse(VASECTOMY == "(1) Yes", 1,
                              ifelse(SP1VAS == "(1) Yes", 1, NA)),
         exclusion_R3 = ifelse(SP2VAS == "(1) Yes" & (is.na(VASECTOMY) | VASECTOMY == "(0) No") & is.na(SP1VAS), 1, exclusion_R3),
         exclusion_R3 = ifelse(is.na(exclusion_R3), 0, exclusion_R3))

x = Fake_cccu_complete1 %>% filter(SP2VAS == "(1) Yes") %>% select(VASECTOMY, SP1VAS, SP2VAS, exclusion_R3)
table(Fake_cccu_complete1$exclusion_R3)

```




# 6 Stepwise exclusion
## 6.1 Missing Main Predictor: HC
Dont exclude current IUD & non-hormonal
## 6.2 Missing Main Predictor: Satisfaction with HC
## 6.3 Missing Main Predictor: Sex Freq & Sex Sat
## 6.4 Missing Selection Predictors
## 6.5 Missing Outcome (switch)
Dont exclude next IUD & non-hormonal
## 6.6 Emergency contraception
## 6.7 IUD & Non-Hormonal
## 6.8 Subanalyses Duration
### 6.8.1 non-hormonal contra
### 6.8.2 unknow duration
## 6.9 Robustness analyses
### 6.9.1. No sex + no contra
### 6.9.2. Sex + no contra
### 6.9.3. Vasectomy


#6 Save df

```{r}

#Main Analysis 

save(Fake_cccu_MA,file = "Fake_cccu_MA.RData")

load("Fake_cccu_MA.RData")


#Sub Analysis
save(Fake_cccu_sub_analysis,file = "Fake_cccu_sub_analysis.RData")

load("Fake_cccu_sub_analysis.RData")

#R1
save(Fake_cccu_R1,file = "Fake_cccu_R1.RData")

load("Fake_cccu_R1.RData")

#R2
save(Fake_cccu_R2,file = "Fake_cccu_R2.RData")

load("Fake_cccu_R2.RData")

#R3
save(Fake_cccu_R3,file = "Fake_cccu_R3.RData")

load("Fake_cccu_R3.RData")
```

