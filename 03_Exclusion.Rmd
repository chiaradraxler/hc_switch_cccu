---
title: "03_Exclusion"
author: "Chiara Draxler"
date: "21 1 2022"
output: html_document
---


#1. Load Data
```{r}

load("Fake_cccu_complete1.RData")
```

#2. Load Packages

```{r}
library(dplyr)
library(formr)
library(ggplot2)
```

#3. Full Dataset
```{r}
nrow(Fake_cccu_complete1) #timepoints
length(unique(Fake_cccu_complete1$CASEID)) #women

```

##3.1 Exclude t4 from df (bc. not necessary)

```{r}
Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
  filter(WAVE != "t4")
```



# 4 Building columns that indicate exclusion from df
1 = yes 

## 4.1 Missing Main Predictor: HC
Dont exclude current IUD & non-hormonal

```{r}
table(Fake_cccu_complete1$hc)
table(is.na(Fake_cccu_complete1$hc))

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_missing_predHC = ifelse(is.na(hc), 1, 0))

table(Fake_cccu_complete1$exclusion_missing_predHC)
Fake_cccu_complete1$exclusion_missing_predHC <- as.factor(Fake_cccu_complete1$exclusion_missing_predHC)
qplot(Fake_cccu_complete1$exclusion_missing_predHC)
```

## 4.2 Missing Main Predictor: Satisfaction with HC
```{r}
table(Fake_cccu_complete1$contra_satis) #@CHIARA@ Variable heiÃŸt contra_satis
table(is.na(Fake_cccu_complete1$contra_satis))

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_missing_pred_contra_satis = ifelse(is.na(contra_satis), 1, 0))

table(Fake_cccu_complete1$exclusion_missing_pred_contra_satis)
Fake_cccu_complete1$exclusion_missing_pred_contra_satis <- as.factor(Fake_cccu_complete1$exclusion_missing_pred_contra_satis)
qplot(Fake_cccu_complete1$exclusion_missing_pred_contra_satis)
```


## 4.3 Missing Main Predictor: Sex Freq & Sex Sat

```{r}
#sex freq
table(Fake_cccu_complete1$sex_freq)
table(is.na(Fake_cccu_complete1$sex_freq))

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_missing_pred_sex_freq= ifelse(is.na(sex_freq), 1, 0))

table(Fake_cccu_complete1$exclusion_missing_pred_sex_freq)
Fake_cccu_complete1$exclusion_missing_pred_sex_freq <- as.factor(Fake_cccu_complete1$exclusion_missing_pred_sex_freq)
qplot(Fake_cccu_complete1$exclusion_missing_pred_sex_freq)

#sex_sat
table(Fake_cccu_complete1$sexual_satisfaction)
table(is.na(Fake_cccu_complete1$sexual_satisfaction))

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_missing_pred_sex_sat= ifelse(is.na(sexual_satisfaction), 1, 0))


table(Fake_cccu_complete1$exclusion_missing_pred_sex_sat)
Fake_cccu_complete1$exclusion_missing_pred_sex_sat <- as.factor(Fake_cccu_complete1$exclusion_missing_pred_sex_sat)
qplot(Fake_cccu_complete1$exclusion_missing_pred_sex_sat)




```

## 4.4 Missing Selection Predictors
@CHIARA@ seperate for all selection variables - otherwise we are unable to see which are the problematic variables
```{r}
Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_missing_selection = as.factor(ifelse(is.na(AGE) | is.na(DEGREE_recode) | is.na(POVRATE)| is.na(HLTHPROB_recode) | is.na(MEDPROB_recode)| is.na(GAPINS_recode) | is.na(TYPEINS_recode) | is.na(NKIDS_t1) |is.na(pregnant_between_waves) | is.na(had_baby_between_waves) | is.na(FEELPG_recode) | is.na(Avoid_recode) | is.na(rel_dur_factor), 1, 0)))

qplot(Fake_cccu_complete1$exclusion_missing_selection)
table(is.na(Fake_cccu_complete1$AGE))
table(is.na(Fake_cccu_complete1$DEGREE_recode))
table(is.na(Fake_cccu_complete1$POVRATE))
table(is.na(Fake_cccu_complete1$HLTHPROB_recode)) #missings!
table(is.na(Fake_cccu_complete1$MEDPROB_recode))
table(is.na(Fake_cccu_complete1$GAPINS_recode)) #missings!
table(is.na(Fake_cccu_complete1$TYPEINS_recode)) #missings!
table(is.na(Fake_cccu_complete1$NKIDS_t1)) #missings!
table(is.na(Fake_cccu_complete1$pregnant_between_waves)) #a lot of missings! something wrong here?
table(is.na(Fake_cccu_complete1$had_baby_between_waves)) #a lot of missings! something wrong here?
table(is.na(Fake_cccu_complete1$FEELPG_recode)) #missings!
table(is.na(Fake_cccu_complete1$Avoid_recode)) #a lot of missings! something wrong here?
table(is.na(Fake_cccu_complete1$rel_dur_factor))
```


## 4.5 Missing Outcome (switch)
Dont exclude next IUD & non-hormonal
```{r}
table(Fake_cccu_complete1$switch)
table(is.na(Fake_cccu_complete1$switch))

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_missing_outc_switch= ifelse(is.na(switch), 1, 0))

table(Fake_cccu_complete1$exclusion_missing_outc_switch)
Fake_cccu_complete1$exclusion_missing_outc_switch <- as.factor(Fake_cccu_complete1$exclusion_missing_outc_switch)

qplot(Fake_cccu_complete1$exclusion_missing_outc_switch)
```


## 4.6 Emergency contraception
```{r}
#overview

table(Fake_cccu_complete1$EC_recode)

#create column that indicates if used EC

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
  mutate(exclusion_used_EC = ifelse(is.na(EC_recode), 0,
                                    ifelse(EC_recode == "No", 0,
                                           ifelse(EC_recode == "Yes", 1, NA))))

table(Fake_cccu_complete1$exclusion_used_EC)
Fake_cccu_complete1$exclusion_used_EC<- as.factor(Fake_cccu_complete1$exclusion_used_EC)
qplot(Fake_cccu_complete1$exclusion_used_EC)

```

## 4.7 IUD & Non-Hormonal
```{r}
#IUD & non-hormonal 
Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_IUD = ifelse(is.na(IUD) & hc == "0", 1,0))

table(is.na(Fake_cccu_complete2$IUD))
table(Fake_cccu_complete2$exclusion_IUD)

crosstabs(~exclusion_IUD + hc + IUD, data = Fake_cccu_complete1)

table(Fake_cccu_complete1$exclusion_IUD)
Fake_cccu_complete1$exclusion_IUD<- as.factor(Fake_cccu_complete1$exclusion_IUD)
qplot(Fake_cccu_complete1$exclusion_IUD)


#IUD_next & non-hormonal 
Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_IUD_next = ifelse(is.na(IUD_next) & hc == "0", 1,0))

table(is.na(Fake_cccu_complete2$IUD_next))
table(Fake_cccu_complete2$exclusion_IUD_next)

crosstabs(~exclusion_IUD_next + hc + IUD_next, data = Fake_cccu_complete1)


table(Fake_cccu_complete1$exclusion_IUD_next)
Fake_cccu_complete1$exclusion_IUD_next<- as.factor(Fake_cccu_complete1$exclusion_IUD_next)
qplot(Fake_cccu_complete1$exclusion_IUD_next)

```


## 4.8 Subanalyses Duration
### 4.8.1 non-hormonal contra
```{r}
table(Fake_cccu_complete1$hc)

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_used_non_hc= ifelse(hc == "0", 1, 0))

table(Fake_cccu_complete1$exclusion_used_non_hc)
Fake_cccu_complete1$exclusion_used_non_hc<- as.factor(Fake_cccu_complete1$exclusion_used_non_hc)
qplot(Fake_cccu_complete1$exclusion_used_non_hc)


```

### 4.8.2 unknow duration
```{r}
table(Fake_cccu_complete1$hc_dur)
table(is.na(Fake_cccu_complete1$hc_dur))

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
 mutate(exclusion_missing_pred_hc_dur= ifelse(is.na(hc_dur), 1, 0))

table(Fake_cccu_complete1$exclusion_missing_pred_hc_dur)
Fake_cccu_complete1$exclusion_missing_pred_hc_dur<- as.factor(Fake_cccu_complete1$exclusion_missing_pred_hc_dur)
qplot(Fake_cccu_complete1$exclusion_missing_pred_hc_dur)


```


## 4.9 Robustness analyses
### 4.9.1. No sex + no contra
```{r}
table(Fake_cccu_complete1$NOBARRIER)#no non-hormonal contraceptive method in last 30days
table(Fake_cccu_complete1$hc)#no hormonal contracepive method 
#joint = no contraceptive method 

table(Fake_cccu_complete1$sex_inlast30days)#no sex in last 30 days

#create column that indicates with 1 = no sex and no contraceptive method used in last 30 days

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
  mutate(exclusion_R1 = ifelse(NOBARRIER == "(1) Yes" & 
                                 hc == "non_hc" &
                                 sex_inlast30days == "No",1,0))

table(Fake_cccu_complete1$exclusion_R1)
Fake_cccu_complete1$exclusion_R1 <-as.factor(Fake_cccu_complete1$exclusion_R1)
qplot(Fake_cccu_complete1$exclusion_R1)


crosstabs(~exclusion_R1 + hc + NOBARRIER + sex_inlast30days, data = Fake_cccu_complete1) #seems to have worked :) :) (see NOBARRIER = (1) Yes, sex_inlast30days = No)

```

### 4.9.2. Sex + no contra

```{r}
#overview over relevant variables

table(Fake_cccu_complete1$NOBARRIER)#no non-hormonal contraceptive method in last 30days
table(Fake_cccu_complete1$hc)#no hormonal contracepive method 
#joint = no contraceptive method 

table(Fake_cccu_complete1$sex_inlast30days)# yes= sex in last 30 days

#create column that indicates with 1 = sex and no contraceptive method used in last 30 days

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
  mutate(exclusion_R2 = ifelse(NOBARRIER == "(1) Yes" & 
                                 hc == "non_hc" &
                                 sex_inlast30days == "Yes",1,0))

table(Fake_cccu_complete1$exclusion_R2)

Fake_cccu_complete1$exclusion_R2 <-as.factor(Fake_cccu_complete1$exclusion_R2)
qplot(Fake_cccu_complete1$exclusion_R2)

crosstabs(~exclusion_R1 + hc + NOBARRIER + sex_inlast30days, data = Fake_cccu_complete1) #seems to have worked :) :) (see NOBARRIER = (1) Yes, sex_inlast30days = Yes)

```

### 4.9.3. Vasectomy
```{r}
#overview

table(Fake_cccu_complete1$VASECTOMY)
table(Fake_cccu_complete1$SP1VAS)
table(Fake_cccu_complete1$SP2VAS)



#create column that indicates if used Vasectomy

Fake_cccu_complete1 <- Fake_cccu_complete1 %>%
  mutate(exclusion_R3 = ifelse(VASECTOMY == "(1) Yes", 1,
                              ifelse(SP1VAS == "(1) Yes", 1, NA)),
         exclusion_R3 = ifelse(SP2VAS == "(1) Yes" & (is.na(VASECTOMY) | VASECTOMY == "(0) No") & is.na(SP1VAS), 1, exclusion_R3),
         exclusion_R3 = ifelse(is.na(exclusion_R3), 0, exclusion_R3))

x = Fake_cccu_complete1 %>% filter(SP2VAS == "(1) Yes") %>% select(VASECTOMY, SP1VAS, SP2VAS, exclusion_R3)
table(Fake_cccu_complete1$exclusion_R3)
crosstabs(~exclusion_R3+SP2VAS, data = Fake_cccu_complete1)

Fake_cccu_complete1$exclusion_R3 <-as.factor(Fake_cccu_complete1$exclusion_R3)
qplot(Fake_cccu_complete1$exclusion_R3)

```




# 5 Stepwise exclusion
## 5.1 Missing Main Predictor: HC
Dont exclude current IUD & non-hormonal
```{r}

#number of observations 
table(Fake_cccu_complete1$exclusion_missing_predHC)

#exclude from df

Fake_cccu_complete2 <-Fake_cccu_complete1 %>%
  filter(exclusion_missing_predHC !=1)

#number of excluded women from Fake_cccu_complete1 bc of exclusion_missing_predHC = 1 (might be combination with other exclusion criteria)
length(unique(Fake_cccu_complete1$CASEID)) -
  Fake_cccu_complete1 %>%
  filter(exclusion_missing_predHC !=1) %>%
  select(CASEID) %>%
  unique() %>%
  nrow() 


```


## 5.2 Missing Main Predictor: Satisfaction with HC
```{r}
#overview number of observations
table(Fake_cccu_complete1$exclusion_missing_pred_contra_satis)

#exclude from df
Fake_cccu_complete3 <-Fake_cccu_complete2 %>%
  filter(exclusion_missing_pred_contra_satis !=1)

#number of excluded women from Fake_cccu_complete1 bc of exclusion_missing_pred_contra_satis = 1 (might be combination with other exclusion criteria)

length(unique(Fake_cccu_complete1$CASEID)) -
  Fake_cccu_complete1 %>%
  filter(exclusion_missing_pred_contra_satis !=1) %>%
  select(CASEID) %>%
  unique() %>%
  nrow()

```


## 5.3 Missing Main Predictor: Sex Freq & Sex Sat

```{r}

#sex freq

#overview number of observations
table(Fake_cccu_complete1$exclusion_missing_pred_sex_freq)

#exclude from df
Fake_cccu_complete4 <-Fake_cccu_complete3 %>%
  filter(exclusion_missing_pred_sex_freq !=1)

#number of excluded women from Fake_cccu_complete1 bc of exclusion_missing_pred_sex_freq = 1 (might be combination with other exclusion criteria)

length(unique(Fake_cccu_complete1$CASEID)) -
  Fake_cccu_complete1 %>%
  filter(exclusion_missing_pred_sex_freq !=1) %>%
  select(CASEID) %>%
  unique() %>%
  nrow()

#sex satis
table(Fake_cccu_complete1$exclusion_missing_pred_sex_sat)


#exclude from df
Fake_cccu_complete5 <-Fake_cccu_complete4 %>%
  filter(exclusion_missing_pred_sex_sat !=1)

#number of excluded women from Fake_cccu_complete1 bc of exclusion_missing_pred_sex_sat = 1 (might be combination with other exclusion criteria)

length(unique(Fake_cccu_complete1$CASEID)) -
  Fake_cccu_complete1 %>%
  filter(exclusion_missing_pred_sex_sat !=1) %>%
  select(CASEID) %>%
  unique() %>%
  nrow()

```

## 5.4 Missing Selection Predictors
```{r}

#overview
table(Fake_cccu_complete1$exclusion_missing_selection)

#exclude from df
Fake_cccu_complete6 <-Fake_cccu_complete5 %>%
  filter(exclusion_missing_selection !=1)

#number of excluded women from Fake_cccu_complete1 bc of exclusion_missing_selection = 1 (might be combination with other exclusion criteria)

length(unique(Fake_cccu_complete1$CASEID)) -
  Fake_cccu_complete1 %>%
  filter(exclusion_missing_selection !=1) %>%
  select(CASEID) %>%
  unique() %>%
  nrow()

```


## 5.5 Missing Outcome (switch)
Dont exclude next IUD & non-hormonal
```{r}
table(Fake_cccu_complete1$exclusion_missing_outc_switch)

#exclude from df
Fake_cccu_complete7 <-Fake_cccu_complete6 %>%
  filter(exclusion_missing_outc_switch !=1)

#number of excluded women from Fake_cccu_complete1 bc of exclusion_missing_outc_switch = 1 (might be combination with other exclusion criteria)

length(unique(Fake_cccu_complete1$CASEID)) -
  Fake_cccu_complete1 %>%
  filter(exclusion_missing_outc_switch !=1) %>%
  select(CASEID) %>%
  unique() %>%
  nrow()



```

## 5.6 Emergency contraception
```{r}
table(Fake_cccu_complete1$exclusion_used_EC)

#exclude from df
Fake_cccu_complete8 <-Fake_cccu_complete7 %>%
  filter(exclusion_used_EC !=1)

#number of excluded women from Fake_cccu_complete1 bc of exclusion_used_EC = 1 (might be combination with other exclusion criteria)

length(unique(Fake_cccu_complete1$CASEID)) -
  Fake_cccu_complete1 %>%
  filter(exclusion_used_EC !=1) %>%
  select(CASEID) %>%
  unique() %>%
  nrow()
```


## 5.7 IUD & Non-Hormonal
```{r}
#IUD 
table(Fake_cccu_complete1$exclusion_IUD)

#exclude from df
Fake_cccu_complete9 <-Fake_cccu_complete8 %>%
  filter(exclusion_IUD !=1)

#number of excluded women from Fake_cccu_complete1 bc of exclusion_IUD = 1 (might be combination with other exclusion criteria)

length(unique(Fake_cccu_complete1$CASEID)) -
  Fake_cccu_complete1 %>%
  filter(exclusion_IUD !=1) %>%
  select(CASEID) %>%
  unique() %>%
  nrow()

#IUD next

table(Fake_cccu_complete1$exclusion_IUD_next)

#exclude from df
Fake_cccu_complete10 <-Fake_cccu_complete9 %>%
  filter(exclusion_IUD_next !=1)

#number of excluded women from Fake_cccu_complete1 bc of exclusion_IUD_next = 1 (might be combination with other exclusion criteria)

length(unique(Fake_cccu_complete1$CASEID)) -
  Fake_cccu_complete1 %>%
  filter(exclusion_IUD_next !=1) %>%
  select(CASEID) %>%
  unique() %>%
  nrow()


```

#rename df for Main Analysis 
```{r}
Fake_cccu_MA <- Fake_cccu_complete10
```

## 5.8 Subanalyses Duration
### 5.8.1 non-hormonal contra
```{r}
table(Fake_cccu_complete1$exclusion_used_non_hc)


#exclude from df
Fake_cccu_SA1 <-Fake_cccu_MA %>%
  filter(exclusion_used_non_hc !=1)

#number of excluded women from Fake_cccu_complete1 bc of exclusion_used_non_hc = 1 (might be combination with other exclusion criteria)

length(unique(Fake_cccu_complete1$CASEID)) -
  Fake_cccu_complete1 %>%
  filter(exclusion_used_non_hc !=1) %>%
  select(CASEID) %>%
  unique() %>%
  nrow()

```

### 5.8.2 unknow duration
```{r}
table(Fake_cccu_complete1$exclusion_missing_pred_hc_dur)

#exclude from df
Fake_cccu_SA <-Fake_cccu_SA1 %>%
  filter(exclusion_missing_pred_hc_dur !=1)

#number of excluded women from Fake_cccu_complete1 bc of exclusion_missing_pred_hc_dur = 1 (might be combination with other exclusion criteria)

length(unique(Fake_cccu_complete1$CASEID)) -
  Fake_cccu_complete1 %>%
  filter(exclusion_missing_pred_hc_dur !=1) %>%
  select(CASEID) %>%
  unique() %>%
  nrow()
```

## 5.9 Robustness analyses
### 5.9.1. No sex + no contra
```{r}
table(Fake_cccu_complete1$exclusion_R1)
#exclude from df
Fake_cccu_R1<-Fake_cccu_MA %>%
  filter(exclusion_R1 !=1)

#number of excluded women from Fake_cccu_complete1 bc of exclusion_R1 = 1 (might be combination with other exclusion criteria)

length(unique(Fake_cccu_complete1$CASEID)) -
  Fake_cccu_complete1 %>%
  filter(exclusion_R1 !=1) %>%
  select(CASEID) %>%
  unique() %>%
  nrow()

#df for subanalysis
Fake_cccu_R1_s<-Fake_cccu_SA %>%
  filter(exclusion_R1 !=1)

```

### 5.9.2. Sex + no contra

```{r}
table(Fake_cccu_complete1$exclusion_R2)
#exclude from df
Fake_cccu_R2<-Fake_cccu_MA %>%
  filter(exclusion_R2 !=1)

#number of excluded women from Fake_cccu_complete1 bc of exclusion_R2 = 1 (might be combination with other exclusion criteria)

length(unique(Fake_cccu_complete1$CASEID)) -
  Fake_cccu_complete1 %>%
  filter(exclusion_R2 !=1) %>%
  select(CASEID) %>%
  unique() %>%
  nrow()

#df for SA
Fake_cccu_R2_s<-Fake_cccu_SA %>%
  filter(exclusion_R2 !=1)

```

### 5.9.3. Vasectomy
```{r}
table(Fake_cccu_complete1$exclusion_R3)
#exclude from df
Fake_cccu_R3<-Fake_cccu_MA %>%
  filter(exclusion_R3 !=1)

#number of excluded women from Fake_cccu_complete1 bc of exclusion_R3 = 1 (might be combination with other exclusion criteria)

length(unique(Fake_cccu_complete1$CASEID)) -
  Fake_cccu_complete1 %>%
  filter(exclusion_R3 !=1) %>%
  select(CASEID) %>%
  unique() %>%
  nrow()

#df for subanalysis
Fake_cccu_R3_s<-Fake_cccu_SA %>%
  filter(exclusion_R3 !=1)
```



#6 Save df

```{r}

#Main Analysis 

save(Fake_cccu_MA,file = "Fake_cccu_MA.RData")

load("Fake_cccu_MA.RData")


#Sub Analysis
save(Fake_cccu_SA,file = "Fake_cccu_SA.RData")

load("Fake_cccu_SA.RData")

#R1
##MA
save(Fake_cccu_R1,file = "Fake_cccu_R1.RData")

load("Fake_cccu_R1.RData")

##SA
save(Fake_cccu_R1_s,file = "Fake_cccu_R1_s.RData")

load("Fake_cccu_R1_s.RData")

#R2
##MA
save(Fake_cccu_R2,file = "Fake_cccu_R2.RData")

load("Fake_cccu_R2.RData")
##SA

save(Fake_cccu_R2_s,file = "Fake_cccu_R2_s.RData")

load("Fake_cccu_R2_s.RData")

#R3
##MA
save(Fake_cccu_R3,file = "Fake_cccu_R3.RData")

load("Fake_cccu_R3.RData")

##SA
save(Fake_cccu_R3_s,file = "Fake_cccu_R3_s.RData")

load("Fake_cccu_R3_s.RData")
```

