---
title: "07_Subanalysis"
author: "Chiara Draxler"
date: "24 1 2022"
output: html_document
---
#1. Load Data
```{r}

load("cccu_SA.RData")
```


#2. Load Packages
```{r}
library(lme4)
library(effects)
```


#3. Models


##3.2 Model 2: including directly with contraceptive method associated predictors

DURATION and satisfaction!

```{r}
sa_m2 <- glmer(switch ~ contra_satis * hc_dur + (1| CASEID), family = binomial, data = cccu_SA, control=glmerControl(optimizer="bobyqa"))

summary(sa_m2)
confint(sa_m2, method = "Wald", level = .997)
plot(allEffects(sa_m2))
```


##3.3 Model 3: including not directly with contraceptive method associated predictors
```{r}
sa_m3 <- glmer(switch ~ contra_satis* hc_dur  +  sexual_satisfaction +  sex_freq + (1| CASEID), family = binomial, data = cccu_SA, control=glmerControl(optimizer="bobyqa"))

summary(sa_m3)
confint(sa_m3, method = "Wald", level = .997)
plot(allEffects(sa_m3))
```

#model 4 as linear model (bc did not converge otherwise)
```{r}
#repeating model 3 as linear model 
sa_m3 <- glm(switch ~ contra_satis* hc_dur  +  sexual_satisfaction +  sex_freq, family = binomial, data = cccu_SA, control=glmerControl(optimizer="bobyqa"))

summary(sa_m3)
confint(sa_m3, method = "Wald", level = .997)
plot(allEffects(sa_m3))

#model 4

sa_m4 <- glm(switch ~ contra_satis*hc_dur +  sexual_satisfaction +   sex_freq + AGE + DEGREE_recode + POVRATE + HLTHPROB_recode + MEDPROB_recode + GAPINS_recode +
              TYPEINS_recode + NKIDS_t1 +  pregnant_between_waves + had_baby_between_waves+ Avoid_r + FEELPG_recode +
              rel_dur_factor,
            family = binomial,
            data = cccu_SA)
summary(sa_m4)
confint(sa_m4, method = "Wald", level = .997)
plot(allEffects(sa_m4))
```

#Senstivity analysis after m4: controlling for unobserved selection effects
```{r}


exp(sa_m4$coefficients)
exp(confint(sa_m4, method = "Wald", level = .997))


#sensitivity analysis for contra_satis
evalue(OR(4.977703e-01,rare=FALSE),lo= 3.259269e-01,  hi=7.548503e-01)

#sensitivity analysis for hc_dur
evalue(OR(8.861297e-01,rare=FALSE),lo= 7.568679e-01,  hi=1.025526e+00)

```


#Average marginal effects
#m2
```{r}
#add predicted values
predictions(sa_m2) |> head()
#contrasts
cmp <- comparisons(sa_m2)
#average marginal effect
summary(cmp)
ame <- marginaleffects(sa_m2)
summary(ame)
```

#m3
```{r}
#add predicted values
predictions(sa_m3) |> head()
#contrasts
cmp <- comparisons(sa_m3)
#average marginal effect
summary(cmp)
ame <- marginaleffects(sa_m3)
summary(ame)
```

#m4
```{r}
#add predicted values
predictions(sa_m4) |> head()
#contrasts
cmp <- comparisons(sa_m4)
#average marginal effect
summary(cmp)
ame <- marginaleffects(sa_m4)
summary(ame)

```

